{% extends "layout.html" %}
{% block title %}代理管理{% endblock %}
{% block content %}

<style>
  .grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  .card{
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 14px 12px;
    box-shadow:0 10px 28px rgba(16,24,40,.08);
  }
  .card h3{margin:0 0 8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:13px;color:#334155}
  .inp{
    width:100%;padding:10px 12px;border:1px solid #d0d7de;border-radius:10px;font-size:14px;
    transition:border-color .15s, box-shadow .15s;
  }
  .inp:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 4px rgba(37,99,235,.14)}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:9px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;
    font-weight:600;font-size:14px;
  }
  .btn.primary{background:#2563eb;color:#fff;box-shadow:0 8px 20px rgba(37,99,235,.22)}
  .btn.ghost{background:#fff;border-color:#d0d7de;color:#111}
  .btn.warn{background:#ef4444;color:#fff}
  .btn:active{transform:translateY(1px)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 10px}
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;
  }
  .badge.on{background:#eaffef;color:#1a7f37;border:1px solid #79d27d}
  .badge.off{background:#fff3f3;color:#b42318;border:1px solid #f1a7a7}

  .table-wrap{border:1px solid #e5e7eb;border-radius:14px;overflow:auto;background:#fff}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
  thead th{
    position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e5e7eb;
    font-weight:700;padding:10px;text-align:left;z-index:1
  }
  tbody td{border-bottom:1px solid #eef2f7;padding:10px;vertical-align:middle}
  tbody tr:hover{background:#fafcff}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:#64748b;font-size:12px}
  .right{margin-left:auto}

  /* 弹窗 */
  .modal-mask{
    position:fixed;inset:0;background:rgba(2,6,23,.45);
    display:none;align-items:center;justify-content:center;z-index:50;
  }
  .modal{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;max-width:380px;width:92%;
    box-shadow:0 18px 50px rgba(2,6,23,.35);animation:pop .18s ease-out}
  @keyframes pop{from{transform:translateY(4px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal h4{margin:0 0 10px}
  .modal .row{display:flex;gap:10px;margin-top:12px}
</style>

<h2 style="margin:0 0 12px">代理管理</h2>

<div class="card">
  <h3>新增代理</h3>
  <form method="post" class="grid2" onsubmit="return checkCreate()">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field">
        <label>用户名</label>
        <input class="inp" name="username" placeholder="如：agent01" required>
      </div>
      <div class="field">
        <label>初始密码</label>
        <input class="inp" name="password" type="password" placeholder="至少 6 位" required>
      </div>
    </div>
    <button class="btn primary" type="submit">创建代理</button>
  </form>
  <div class="muted" style="margin-top:6px">提示：代理密码将以哈希方式存储（pbkdf2:sha256）。</div>
</div>

<div class="toolbar">
  <div class="field" style="flex:1;min-width:220px">
    <label class="muted">搜索</label>
    <input id="filter" class="inp" placeholder="按用户名过滤…" oninput="filterAgents()">
  </div>
  <div class="right muted">共 <span id="countAll">{{ agents|length }}</span> 个代理，已显示 <span id="countShown">{{ agents|length }}</span></div>
</div>

<div class="table-wrap">
  <table id="agentsTable">
    <thead>
      <tr>
        <th style="width:70px">ID</th>
        <th>用户名</th>
        <th style="width:120px">状态</th>
        <th style="width:200px">创建时间</th>
        <th style="width:260px">操作</th>
      </tr>
    </thead>
    <tbody>
      {% for a in agents %}
      <tr data-name="{{ a.username|lower }}">
        <td>#{{ a.id }}</td>
        <td><strong>{{ a.username }}</strong></td>
        <td>
          {% if a.is_active %}
            <span class="badge on">启用</span>
          {% else %}
            <span class="badge off">停用</span>
          {% endif %}
        </td>
        <td class="muted">{{ a.created_at }}</td>
        <td>
          <div class="actions">
            <form method="post" action="{{ url_for('agent_toggle', agent_id=a.id) }}" onsubmit="return confirm('确认{{ '停用' if a.is_active else '启用' }}该代理？')">
              <button class="btn ghost" type="submit">{{ '停用' if a.is_active else '启用' }}</button>
            </form>

            <button class="btn ghost" type="button" onclick="openReset({{ a.id }}, '{{ a.username }}')">重置密码</button>

            <!-- 可选：一键复制登录名 -->
            <button class="btn ghost" type="button" onclick="copyText('{{ a.username }}')">复制用户名</button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 重置密码弹窗 -->
<div class="modal-mask" id="resetMask" role="dialog" aria-modal="true">
  <div class="modal">
    <h4>重置密码：<span id="resetUser"></span></h4>
    <form method="post" id="resetForm">
      <input type="hidden" id="resetAction" value="">
      <div class="field">
        <label>新密码</label>
        <input class="inp" id="newPwd" name="new_password" type="password" placeholder="至少 6 位" required>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" onclick="closeReset()">取消</button>
        <button class="btn warn right" type="submit">确认重置</button>
      </div>
    </form>
  </div>
</div>

<script>
  function checkCreate(){
    const u = document.querySelector('input[name="username"]');
    const p = document.querySelector('input[name="password"]');
    if(!u.value.trim() || !p.value){ return false; }
    if(p.value.length < 6){
      alert('初始密码至少 6 位'); return false;
    }
    return true;
  }

  function filterAgents(){
    const q = (document.getElementById('filter').value || '').trim().toLowerCase();
    const rows = Array.from(document.querySelectorAll('#agentsTable tbody tr'));
    let shown = 0;
    rows.forEach(tr=>{
      const name = tr.getAttribute('data-name') || '';
      const ok = !q || name.includes(q);
      tr.style.display = ok ? '' : 'none';
      if(ok) shown++;
    });
    document.getElementById('countShown').textContent = shown;
  }

  function copyText(t){
    navigator.clipboard.writeText(t).then(()=>alert('已复制')).catch(()=>alert('复制失败'));
  }

  // 重置密码弹窗
  function openReset(id, username){
    document.getElementById('resetUser').textContent = username;
    const form = document.getElementById('resetForm');
    form.action = `{{ url_for('agent_reset', agent_id=0) }}`.replace('/0/', `/${id}/`);
    document.getElementById('newPwd').value = '';
    document.getElementById('resetMask').style.display = 'flex';
    setTimeout(()=>document.getElementById('newPwd').focus(), 50);
  }
  function closeReset(){
    document.getElementById('resetMask').style.display = 'none';
  }
  document.getElementById('resetForm').addEventListener('submit', function(e){
    const v = document.getElementById('newPwd').value;
    if(!v || v.length < 6){
      e.preventDefault();
      alert('新密码至少 6 位');
    }
  });

  // ESC 关闭弹窗
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape') closeReset();
  });
</script>

{% endblock %}
