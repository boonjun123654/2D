{% extends "layout.html" %}
{% block title %}代理管理{% endblock %}
{% block header_title %}代理管理{% endblock %}

{% block head_extra %}
<style>
  .card{
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;
    box-shadow:0 8px 22px rgba(16,24,40,.06);padding:14px;margin:12px 0;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  .input, .btn{
    height:38px;padding:0 12px;border-radius:10px;border:1px solid #d0d7de;background:#fff;
    font-size:14px
  }
  .btn-primary{background:#1b84ff;border-color:#1b84ff;color:#fff;cursor:pointer}
  .btn-danger {background:#ef4444;border-color:#e11d48;color:#fff;cursor:pointer}
  .btn-danger:active,.btn-primary:active{transform:translateY(1px)}
  .muted{color:#666;font-size:12px}

  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-weight:600;color:#374151;text-align:left;padding:8px 10px}
  .table td{
    background:#fff;border:1px solid #e5e7eb;border-left-width:0;border-right-width:0;
    padding:10px;border-radius:0
  }
  .table tr td:first-child{border-left-width:1px;border-top-left-radius:12px;border-bottom-left-radius:12px}
  .table tr td:last-child{border-right-width:1px;border-top-right-radius:12px;border-bottom-right-radius:12px}
  .search{width:320px;max-width:100%}
  code.badge{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:8px;padding:2px 8px}
  @media (max-width:640px){
    .table th:nth-child(3), .table td:nth-child(3){display:none} /* 小屏隐藏创建时间列，保留操作列 */
  }
</style>
{% endblock %}

{% block content %}
  <!-- 新增代理 -->
  <div class="card">
    <h3 style="margin:0 0 8px">新增代理</h3>
    <form method="post" class="row" action="{{ url_for('agents_admin') }}">
      <input class="input" type="text" name="username" placeholder="用户名，如：agent01" required minlength="1">
      <input class="input" type="password" name="password" placeholder="初始密码（至少 6 位）" required minlength="6">
      <button class="btn btn-primary" type="submit">创建代理</button>
    </form>
    <div class="muted" style="margin-top:6px"></div>
  </div>

  <!-- 搜索 -->
  <div class="row" style="align-items:center;justify-content:space-between;margin:8px 0">
    <div class="muted">搜索</div>
    <input id="searchBox" class="input search" type="text" placeholder="按用户名过滤…">
  </div>

  <!-- 列表 -->
  <table class="table" id="agentsTable" aria-label="代理列表">
    <thead>
      <tr>
        <th style="width:80px">ID</th>
        <th>用户名</th>
        <th style="width:240px">创建时间</th>
        <th style="width:140px">操作</th>
      </tr>
    </thead>
    <tbody>
      {% for a in agents %}
      <tr data-username="{{ a.username|lower }}">
        <td><code class="badge">#{{ a.id }}</code></td>
        <td style="font-weight:600">{{ a.username }}</td>
        <td class="muted">{{ a.created_at }}</td>
        <td>
          <form method="post" action="{{ url_for('agent_delete', agent_id=a.id) }}" onsubmit="return confirm('确定删除？');" style="display:inline">
            <button type="submit" class="btn btn-danger">删除</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4" class="muted" style="text-align:center">暂无代理</td></tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}

{% block body_extra %}
<script>
  // 简单本地搜索（按用户名）
  document.getElementById('searchBox')?.addEventListener('input', function(){
    const kw = this.value.trim().toLowerCase();
    document.querySelectorAll('#agentsTable tbody tr').forEach(tr=>{
      const u = tr.getAttribute('data-username') || '';
      tr.style.display = (!kw || u.includes(kw)) ? '' : 'none';
    });
  });
</script>
{% endblock %}
