{% extends "layout.html" %}
{% block title %}历史记录{% endblock %}
{% block header_title %}历史记录{% endblock %}

{% block head_extra %}
<style>
  .muted{color:#666}
  /* 顶部筛选行：更紧凑，移动端换行 */
  .filters{
    margin:8px 0 10px;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .filters label{white-space:nowrap}
  .filters input[type="date"]{
    height:34px; padding:4px 8px; border:1px solid #d0d7de; border-radius:8px; background:#fff;
  }
  .filters button{
    height:34px; padding:0 12px; border:1px solid #1b84ff; background:#1b84ff; color:#fff; border-radius:8px;
  }

  /* 卡片整体 */
  .card{
    background:#fff; border:1px solid #e5e7eb; border-radius:14px;
    box-shadow:0 8px 22px rgba(16,24,40,.06); padding:12px; margin:12px 0;
  }

  /* 顶部行：左侧订单，右侧代理徽章+删除 */
  .card-top{
    display:flex; align-items:center; gap:10px; min-height:34px;
  }
  .card-top .left{
    min-width:0; display:flex; align-items:center; gap:8px;
  }
  .card-top .label{
    font-size:12px; color:#6b7280; letter-spacing:.02em;
  }
  .card-top .oc{
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:14px; background:#f6f8fa; border:1px solid #e5e7eb;
    border-radius:8px; padding:3px 8px; white-space:nowrap; max-width:60vw; overflow:hidden; text-overflow:ellipsis;
  }
  .card-top .right{
    margin-left:auto; display:flex; align-items:center; gap:8px;
  }
  .agent-badge{
    display:inline-flex; align-items:center; justify-content:center;
    height:28px; min-width:38px; padding:0 10px; border-radius:999px;
    background:#eef2ff; color:#1e40af; border:1px solid #dbe3ff; font-weight:600; font-size:13px;
  }
  .btn-del{
    height:28px; padding:0 12px; border-radius:10px;
    background:#ef4444; color:#fff; border:1px solid #e11d48; cursor:pointer;
  }
  .btn-del:active{ transform:translateY(1px) }

  /* 文本主体 */
  .card-body{
    margin-top:8px;
    white-space:pre-wrap; word-break:break-word;
    font-size:14px; line-height:1.55; color:#111;
  }

  /* 空态 */
  .empty{
    color:#999; border:1px dashed #ddd; border-radius:12px; padding:14px; margin-top:10px;
    background:#fff;
  }
</style>
{% endblock %}

{% block content %}
  <div class="muted">选择日期范围查看历史下注摘要（每个订单一张卡片）。</div>
  <form method="get" class="filters">
    <label>开始日期：</label>
    <input type="date" name="start_date" value="{{ start_date or date }}">
    <label>结束日期：</label>
    <input type="date" name="end_date" value="{{ end_date or start_date or date }}">
    <button type="submit">查询</button>
  </form>

  <div id="cards"></div>

  <!-- 后端传 rows_js：[{order_code, agent_id, market, code, number, amount_*}] -->
  <script id="rowsData" type="application/json">{{ rows_js|tojson if rows_js else '[]' }}</script>
{% endblock %}

{% block body_extra %}
<script>
const MARKETS = ['M','P','T','S','B','K','W','H','E'];
const fmt = n => {
  const v = Number(n||0);
  if (!isFinite(v)) return '0';
  const s = v.toFixed(2);
  return s.replace(/\.?0+$/,'');
};

(function(){
  const rows = JSON.parse(document.getElementById('rowsData').textContent || '[]');
  const cards = document.getElementById('cards');
  if (!rows.length){ cards.innerHTML = '<div class="empty">该日期范围暂无注单。</div>'; return; }

  // 按 order_code 分组
  const groups = new Map();
  for(const r of rows){
    if(!groups.has(r.order_code)) groups.set(r.order_code, []);
    groups.get(r.order_code).push(r);
  }

  for(const [oc, list] of groups){
    const agentId = list[0]?.agent_id ?? '-';

    // 时段
    const hourSet = new Set();
    for(const it of list){
      const h = (it.code||'').split('/')[1]?.slice(0,2);
      if (h) hourSet.add(h);
    }
    const slotsLine = [...hourSet].sort().join('-') || '-';

    // 市场（合并去重并按固定顺序）
    const mset = new Set();
    for(const it of list){ (it.market||'').split('').forEach(ch=>mset.add(ch)); }
    const marketLine = '*' + (MARKETS.filter(m => mset.has(m)).join('') || '-');

    // 明细行（号码+金额去重）
    const asKey = it => [
      it.number, fmt(it.amount_n1), fmt(it.amount_n), fmt(it.amount_b),
      fmt(it.amount_s), fmt(it.amount_ds), fmt(it.amount_ss)
    ].join('|');

    const uniq = new Map();
    for(const it of list){ const k = asKey(it); if(!uniq.has(k)) uniq.set(k, it); }
    const lines = [...uniq.values()]
      .sort((a,b)=> (a.number||'').localeCompare(b.number||''))
      .map(it=>{
        const parts = [];
        if(Number(it.amount_n1)>0) parts.push(`${fmt(it.amount_n1)}N1`);
        if(Number(it.amount_n )>0) parts.push(`${fmt(it.amount_n )}N`);
        if(Number(it.amount_b )>0) parts.push(`${fmt(it.amount_b )}B`);
        if(Number(it.amount_s )>0) parts.push(`${fmt(it.amount_s )}S`);
        if(Number(it.amount_ds)>0) parts.push(`${fmt(it.amount_ds)}O`);
        if(Number(it.amount_ss)>0) parts.push(`${fmt(it.amount_ss)}E`);
        return `${it.number} = ${parts.join(' ')}`;
      });

    // GT：base * 市场数
    let gt = 0;
    for(const it of list){
      const base =
        Number(it.amount_n1||0)+Number(it.amount_n||0)+Number(it.amount_b||0)+
        Number(it.amount_s||0)+Number(it.amount_ds||0)+Number(it.amount_ss||0);
      const mcnt = new Set((it.market||'').split('')).size || 0;
      gt += base * mcnt;
    }
    const gtLine = `GT=${fmt(gt)}`;

    // 组装文案
    const text = [slotsLine, marketLine, ...lines, '', gtLine].join('\n');

    // 渲染卡片（新版结构）
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="card-top">
        <div class="left">
          <span class="label">订单</span>
          <code class="oc" title="${oc}">${oc}</code>
        </div>
        <div class="right">
          <span class="agent-badge">#${agentId}</span>
          <button type="button" class="btn-del del-order" title="删除此订单">删除</button>
        </div>
      </div>
      <pre class="card-body"></pre>
    `;
    div.querySelector('.card-body').textContent = text;
    cards.appendChild(div);

    // 删除
    div.querySelector('.del-order').addEventListener('click', async ()=>{
      if(!confirm(`确定删除该订单（${oc}）？\n此操作会将数据库中本订单的 status 设为 delete。`)) return;
      try{
        const body = new URLSearchParams({order_code: oc});
        const resp = await fetch('/2d/history/delete', {
          method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body
        });
        const data = await resp.json().catch(()=>({}));
        if(resp.ok && data.ok){
          div.remove();
          if(!cards.children.length) cards.innerHTML = '<div class="empty">暂无记录。</div>';
        }else{
          alert('删除失败：' + (data.error || resp.status));
        }
      }catch(err){ alert('删除失败：' + err); }
    });
  }
})();
</script>
{% endblock %}
