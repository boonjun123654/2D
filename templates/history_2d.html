{% extends "layout.html" %}
{% block title %}历史记录{% endblock %}
{% block header_title %}历史记录{% endblock %}

{% block head_extra %}
<style>
  .muted{color:#666}
  .card{
    background:#fff;border:1px solid #e5e7eb;border-radius:12px;
    box-shadow:0 10px 28px rgba(16,24,40,.06);padding:12px 14px;margin:14px 0
  }
  .card-title{display:flex;align-items:center;gap:12px;margin-bottom:6px}
  .card-title .oc{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .btn-danger{
    margin-left:auto;padding:6px 10px;border:1px solid #e11d48;
    color:#fff;background:#ef4444;border-radius:8px;cursor:pointer;
  }
  .btn-danger:hover{ background:#dc2626 }
  pre{white-space:pre-wrap;word-break:break-word;margin:4px 0 0}
  .empty{color:#999;border:1px dashed #ddd;border-radius:12px;padding:14px;margin-top:10px}
</style>
{% endblock %}

{% block content %}
  <div class="muted"></div>
  <form method="get" style="margin:8px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
    <label>开始日期：</label>
    <input type="date" name="start_date" value="{{ start_date or date }}">
    <label>结束日期：</label>
    <input type="date" name="end_date" value="{{ end_date or start_date or date }}">
    <button type="submit">查询</button>
  </form>

  <div id="cards"></div>

  <!-- 数据（后端传入 rows_js：已按筛选范围返回的记录列表） -->
  <script id="rowsData" type="application/json">{{ rows_js|tojson if rows_js else '[]' }}</script>
{% endblock %}

{% block body_extra %}
<script>
/* 工具 */
const MARKETS = ['M','P','T','S','B','K','W','H','E'];
const fmt = n => {
  const v = Number(n||0);
  if (!isFinite(v)) return '0';
  const s = v.toFixed(2);
  return s.replace(/\.?0+$/,'');
};

/* 分组并渲染（每个 order_code 一卡） */
(function(){
  const rows = JSON.parse(document.getElementById('rowsData').textContent || '[]');
  const cards = document.getElementById('cards');
  if (!rows.length){ cards.innerHTML = '<div class="empty">该日期范围暂无注单。</div>'; return; }

  // 按 order_code 分组（保持原顺序）
  const groups = new Map();
  for(const r of rows){
    if(!groups.has(r.order_code)) groups.set(r.order_code, []);
    groups.get(r.order_code).push(r);
  }

  for(const [oc, list] of groups){
    const agentId = list[0]?.agent_id ?? '-';

    // 时段（从 code 取小时）
    const hourSet = new Set();
    for(const it of list){
      const h = (it.code||'').split('/')[1]?.slice(0,2);
      if (h) hourSet.add(h);
    }
    const slotsLine = [...hourSet].sort().join('-') || '-';

    // 市场（合并去重并按固定顺序）
    const mset = new Set();
    for(const it of list){
      (it.market||'').split('').forEach(ch=>mset.add(ch));
    }
    const marketLine = '*' + (MARKETS.filter(m => mset.has(m)).join('') || '-');

    // 明细行：按“号码+金额组合”去重，按号码排序
    const asKey = it => [
      it.number, fmt(it.amount_n1), fmt(it.amount_n), fmt(it.amount_b),
      fmt(it.amount_s), fmt(it.amount_ds), fmt(it.amount_ss)
    ].join('|');

    const uniq = new Map();
    for(const it of list){
      const key = asKey(it);
      if(!uniq.has(key)) uniq.set(key, it);
    }
    const lines = [...uniq.values()]
      .sort((a,b)=> (a.number||'').localeCompare(b.number||''))
      .map(it=>{
        const parts = [];
        if(Number(it.amount_n1)>0) parts.push(`${fmt(it.amount_n1)}N1`);
        if(Number(it.amount_n )>0) parts.push(`${fmt(it.amount_n )}N`);
        if(Number(it.amount_b )>0) parts.push(`${fmt(it.amount_b )}B`);
        if(Number(it.amount_s )>0) parts.push(`${fmt(it.amount_s )}S`);
        if(Number(it.amount_ds)>0) parts.push(`${fmt(it.amount_ds)}O`);
        if(Number(it.amount_ss)>0) parts.push(`${fmt(it.amount_ss)}E`);
        return `${it.number} = ${parts.join(' ')}`;
      });

    // GT：每条记录 base * 该条目的市场数（保存的是合并后的市场字符串）
    let gt = 0;
    for(const it of list){
      const base =
        Number(it.amount_n1||0)+Number(it.amount_n||0)+Number(it.amount_b||0)+
        Number(it.amount_s||0)+Number(it.amount_ds||0)+Number(it.amount_ss||0);
      const mcnt = new Set((it.market||'').split('')).size || 0;
      gt += base * mcnt;
    }
    const gtLine = `GT=${fmt(gt)}`;

    // 组装文本
    const text = [slotsLine, marketLine, ...lines, '', gtLine].join('\n');

    // 渲染卡片
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="card-title">
        <div class="muted">订单：</div><code class="oc">${oc}</code>
        <div class="muted" style="margin-left:8px">代理ID：</div><strong>#${agentId}</strong>
        <button type="button" class="btn-danger del-order" title="删除此订单">删除</button>
      </div>
      <pre></pre>
    `;
    div.querySelector('pre').textContent = text; // 避免 HTML 注入
    cards.appendChild(div);

    // 绑定删除按钮
    const btn = div.querySelector('.del-order');
    btn.addEventListener('click', async ()=>{
      if(!confirm(`确定删除该订单（${oc}）？\n此操作会将数据库中本订单的 status 设为 delete。`)) return;
      try{
        const body = new URLSearchParams({order_code: oc});
        const resp = await fetch('/2d/history/delete', {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const data = await resp.json().catch(()=>({}));
        if(resp.ok && data.ok){
          div.remove();
          if(!cards.children.length){
            cards.innerHTML = '<div class="empty">暂无记录。</div>';
          }
        }else{
          alert('删除失败：' + (data.error || resp.status));
        }
      }catch(err){
        alert('删除失败：' + err);
      }
    });
  }
})();
</script>
{% endblock %}
