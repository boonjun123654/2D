{% extends "layout.html" %}
{% block title %}下注记录{% endblock %}
{% block header_title %}下注记录{% endblock %}

{% block head_extra %}
<style>
  :root{
    --c-border:#e5e7eb; --c-muted:#6b7280; --c-bg:#ffffff; --c-chip:#f1f5f9;
    --ok:#1a6ee8; --warn:#b76e00; --danger:#ef4444; --brand:#1b84ff;
  }
  /* 顶部筛选区（紧凑、适配手机） */
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px}
  .filters label{font-size:13px;color:#334155}
  .filters input[type="date"]{
    height:36px;padding:6px 10px;border:1px solid var(--c-border);border-radius:10px;background:#fff
  }
  .filters button{
    height:36px;padding:0 14px;border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px
  }

  /* 卡片（手机优先） */
  .card{background:var(--c-bg);border:1px solid var(--c-border);border-radius:14px;
        box-shadow:0 8px 22px rgba(16,24,40,.06);padding:12px;margin:12px 0}
  .row{display:flex;gap:8px;margin:2px 0;align-items:flex-start}
  .row .label{flex:0 0 64px;color:var(--c-muted);font-size:13px;line-height:20px}
  .row .value{flex:1;min-width:0}

  .pill{display:inline-flex;align-items:center;justify-content:center;height:26px;
        padding:0 10px;border-radius:999px;background:#eef2ff;color:#1e40af;border:1px solid #dbe3ff;
        font-weight:600;font-size:12px}
  .code{display:inline-block;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size:13px;background:#f6f8fa;border:1px solid var(--c-border);
        padding:4px 8px;border-radius:8px;word-break:break-all}

  .market-chip{display:inline-block;background:var(--c-chip);border:1px solid var(--c-border);
               padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px;margin-bottom:4px}

  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid}
  .status.active{background:#e6f4ff;color:var(--ok);border-color:#b3d5ff}
  .status.locked{background:#fff7e6;color:var(--warn);border-color:#ffd591}

  .bets{white-space:pre-wrap;word-break:break-word;font-size:15px;line-height:1.5;margin-top:8px}
  .total{font-weight:700;margin-top:6px}

  .card-actions{display:flex;gap:10px;margin-top:10px}
  .btn{flex:1;height:38px;border-radius:10px;border:1px solid transparent}
  .btn.copy{background:#0ea5e9;color:#fff;border-color:#0284c7}
  .btn.delete{background:var(--danger);color:#fff;border-color:#dc2626}
  .btn[disabled]{opacity:.6;filter:grayscale(20%);cursor:not-allowed}

  .empty{color:#999;border:1px dashed var(--c-border);border-radius:12px;padding:14px;margin-top:10px;background:#fff}
</style>
{% endblock %}

{% block content %}
  <form method="get" class="filters">
    <label>开始日期：</label>
    <input type="date" name="start_date" value="{{ start_date or date }}">
    <label>结束日期：</label>
    <input type="date" name="end_date" value="{{ end_date or start_date or date }}">
    <button type="submit">查询</button>
  </form>

  <div id="cards"></div>

  <!-- 必需数据 -->
  <script id="rowsData" type="application/json">{{ rows_js|tojson if rows_js else '[]' }}</script>
  <script id="serverNow" type="application/json">{{ now_ts|tojson if now_ts else 'null' }}</script>
  <!-- 可选：后端可传 {agent_id: "username"}，管理员视角显示代理名更准确 -->
  <script id="agentNames" type="application/json">{{ agent_names|tojson if agent_names else 'null' }}</script>
{% endblock %}

{% block body_extra %}
<script>
/* ==== 配置 ==== */
const KNOWN_MARKETS = ['MGV21','UCA68','SFC99'];

/* ==== 工具 ==== */
const fmt = n => {
  const v = Number(n||0);
  if (!isFinite(v)) return '0';
  const s = v.toFixed(2);
  return s.replace(/\.?0+$/,'');
};
const SERVER_NOW = (() => {
  try { const t = JSON.parse(document.getElementById('serverNow').textContent||'null'); return t ? new Date(t) : new Date(); }
  catch(_) { return new Date(); }
})();
const AGENT_NAMES = (() => {
  try { return JSON.parse(document.getElementById('agentNames').textContent||'null') || {}; }
  catch(_) { return {}; }
})();

/* 把 market 字段解析成有序去重数组，兼容 "A,B,C" 与 "ABC"（无分隔） */
function parseMarkets(m) {
  const raw = String(m||'').trim();
  if (!raw) return [];
  if (raw.includes(',')) {
    const arr = raw.split(',').map(s=>s.trim()).filter(Boolean);
    const set = new Set(arr);                       // 去重
    return KNOWN_MARKETS.filter(x => set.has(x));   // 固定顺序
  }
  // 无分隔：扫描已知 token
  const found = [];
  for (const token of KNOWN_MARKETS) {
    if (raw.includes(token)) found.push(token);
  }
  return found;
}

/* 组装一笔订单的展示文本与统计 */
function buildOrderView(list) {
  // 小时集合
  const hours = new Set();
  list.forEach(it => {
    const part = (it.code||'').split('/')[1] || '';
    if (part) hours.add(part.slice(0,2));
  });
  const slotsLine = [...hours].sort().join('-') || '-';

  // 市场（订单层面合并）
  const mset = new Set();
  list.forEach(it => parseMarkets(it.market).forEach(x => mset.add(x)));
  const marketsOrdered = KNOWN_MARKETS.filter(x => mset.has(x));
  const marketLineText = marketsOrdered.join('/');

  // 行去重（号码 + 六项金额）
  const keyOf = it => [
    it.number, fmt(it.amount_n1), fmt(it.amount_n), fmt(it.amount_b),
    fmt(it.amount_s), fmt(it.amount_ds), fmt(it.amount_ss)
  ].join('|');
  const uniq = new Map();
  list.forEach(it => { const k = keyOf(it); if (!uniq.has(k)) uniq.set(k, it); });

  // 明细行：如 45=4N1 1N 1B 1S 1O 1E
  const detailLines = [...uniq.values()].sort((a,b)=>(a.number||'').localeCompare(b.number||'')).map(it=>{
    const parts = [];
    const push = (v, tag) => { const n = Number(v||0); if (n>0) parts.push(`${fmt(n)}${tag}`); };
    push(it.amount_n1,'N1'); push(it.amount_n,'N'); push(it.amount_b,'B');
    push(it.amount_s,'S');   push(it.amount_ds,'O'); push(it.amount_ss,'E');
    return `${it.number}=${parts.join(' ')}`;
  });

  // 订单是否锁注（任意行过锁时间即为已锁注）
  const isLocked = list.some(it => it.locked_at && (new Date(it.locked_at) <= SERVER_NOW));

  // Total = Σ(该行六项金额和 × 该行市场数)
  let total = 0;
  list.forEach(it=>{
    const base = Number(it.amount_n1||0)+Number(it.amount_n||0)+Number(it.amount_b||0)+
                 Number(it.amount_s||0)+Number(it.amount_ds||0)+Number(it.amount_ss||0);
    const mcnt = parseMarkets(it.market).length;
    total += base * mcnt;
  });

  return {
    slotsLine,
    marketLineText,
    detailText: detailLines.join('\n'),
    total: fmt(total),
    marketsOrdered,
    isLocked
  };
}

/* ==== 渲染 ==== */
(function(){
  const rows = JSON.parse(document.getElementById('rowsData').textContent||'[]');
  const mount = document.getElementById('cards');
  if (!rows.length) { mount.innerHTML = '<div class="empty">该日期范围暂无注单。</div>'; return; }

  // 按 order_code 分组
  const groups = new Map();
  for (const r of rows) {
    if (!groups.has(r.order_code)) groups.set(r.order_code, []);
    groups.get(r.order_code).push(r);
  }

  for (const [oc, list] of groups) {
    const agentName = String(list[0]?.agent_id || '-');

    const v = buildOrderView(list);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row"><div class="label">代理：</div><div class="value"><span class="pill">${agentName}</span></div></div>
      <div class="row"><div class="label">订单：</div><div class="value"><span class="code">${oc}</span></div></div>
      <div class="row"><div class="label">时段：</div><div class="value">${v.slotsLine || '-'}</div></div>
      <div class="row">
        <div class="label">市场：</div>
        <div class="value">
          ${v.marketsOrdered.map(m=>`<span class="market-chip">${m}</span>`).join('')}
        </div>
      </div>
      <div class="row"><div class="label">状态：</div><div class="value">
        <span class="status ${v.isLocked?'locked':'active'}">${v.isLocked?'已锁注':'活跃'}</span>
      </div></div>
      <div class="bets"></div>
      <div class="total">Total=${v.total}</div>
      <div class="card-actions">
        <button type="button" class="btn copy">复制</button>
        <button type="button" class="btn delete" ${v.isLocked?'disabled':''}>删除</button>
      </div>
    `;
    card.querySelector('.bets').textContent = v.detailText || '-';
    mount.appendChild(card);

    /* 复制：仅复制“市场 + 明细 + Total” */
    const copyBtn = card.querySelector('.btn.copy');
    copyBtn.addEventListener('click', async ()=>{
      const text = `时段：${v.slotsLine || '-'}\n市场：${v.marketLineText || '-'}\n\n${v.detailText}\n\nTotal=${v.total}`;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = '已复制';
        setTimeout(()=>copyBtn.textContent='复制',1200);
      } catch (e) {
        alert('复制失败，请手动选择文字');
      }
    });

    /* 删除：命中后端 /2d/history/delete（整单） */
    const delBtn = card.querySelector('.btn.delete');
    delBtn.addEventListener('click', async ()=>{
      if (delBtn.disabled) return;
      if (!confirm('确定删除该订单？')) return;
      try{
        const body = new URLSearchParams({order_code: oc});
        const resp = await fetch('/2d/history/delete', {
          method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body
        });
        const data = await resp.json().catch(()=>({}));
        if (resp.ok && data.ok) {
          card.remove();
          if (!mount.children.length) mount.innerHTML = '<div class="empty">暂无记录。</div>';
        } else {
          alert('删除失败：' + (data.error || resp.status));
        }
      }catch(err){ alert('删除失败：' + err); }
    });
  }
})();
</script>
{% endblock %}
