<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>2D 下注</title>
  <style>
    :root{
      --c-border:#d0d7de; --c-head:#f6f8fa; --c-muted:#666;
      --c-blue:#1f6feb; --c-red:#b91c1c; --c-green:#0f5132; --c-yellow:#ffd400; --c-orange:#f0ad4e;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif; padding:12px;}
    h1{margin:0 0 10px}
    .muted{color:var(--c-muted)}
    .btn{padding:6px 12px;border:1px solid var(--c-border);background:#fff;border-radius:8px;cursor:pointer}
    .btn.primary{background:#0969da;color:#fff;border-color:#0969da}
    .flash{padding:10px;border-radius:8px;margin:10px 0}
    .flash.ok{background:#e6ffed;border:1px solid #79d27d}
    .flash.error{background:#ffe6e6;border:1px solid #ff9999}

    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;background:#fff;border:1px solid var(--c-border);border-radius:10px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--c-border);padding:6px 8px;font-size:14px;text-align:center}
    th{background:var(--c-head)}
    .sticky-head th{position:sticky;top:0;background:var(--c-head);z-index:2}

    /* 输入更紧凑（号码/金额） */
    input[type="text"]{width:56px;text-align:center}
    input[type="number"]{width:72px;text-align:right}

    /* 顶部“列控制”的小方块 */
    .headbar{display:grid;gap:6px;justify-content:center;margin-top:6px}
    .headbar.slots{grid-template-columns:repeat(15,32px)}
    .headbar.markets{grid-template-columns:repeat(9,32px)}
    .headbox{position:relative;width:32px;height:26px;display:flex;align-items:center;justify-content:center}
    .headbox input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .headbox span{
      width:18px;height:18px;background:#fff;border:1px solid var(--c-border);border-radius:4px;pointer-events:none;
    }
    .headbox input:checked + span{box-shadow:0 0 0 2px #111 inset;background:#e8f0ff}

    /* 时间段：行内小方块，可横向滑动 */
    .slots-head{display:grid;grid-template-columns:repeat(15,32px);gap:6px;justify-content:center}
    .slots-row{display:grid;grid-auto-flow:column;grid-auto-columns:32px;gap:6px;overflow-x:auto;padding:2px 0;scroll-snap-type:x proximity}
    .slot{position:relative;width:32px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;scroll-snap-align:center}
    .slot.locked{opacity:.35}
    .slot input{
      position:absolute;inset:0;width:100%;height:100%;
      opacity:0;cursor:pointer;z-index:3;-webkit-appearance:none;appearance:none;background:transparent;
      touch-action:manipulation;
    }
    .slot .box{
      width:22px;height:22px;border:1px solid var(--c-border);border-radius:6px;background:#fff;pointer-events:none;z-index:1;
    }
    .slot input:checked + .box{border-color:#111;background:#e8f0ff;box-shadow:0 0 0 2px #111 inset}
    .slot.on .box{border-color:#111;background:#e8f0ff;box-shadow:0 0 0 2px #111 inset}

    /* 市场：整列彩色背景 + 白色小方块（像截图那样） */
    .m-legend{display:grid;grid-template-columns:repeat(9,32px);gap:6px;justify-content:center}
    .mgrid{display:grid;grid-auto-flow:column;grid-auto-columns:32px;gap:6px;overflow-x:auto;justify-content:flex-start;padding:2px 0}
    .mtick{position:relative;width:32px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center}
    .mtick input{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:3}
    .mbox{width:18px;height:18px;background:#fff;border:1px solid var(--c-border);border-radius:4px;pointer-events:none;z-index:1}
    .mtick input:checked + .mbox{border-color:#111;box-shadow:0 0 0 2px #111 inset}
    .mtick.on .mbox{border-color:#111;box-shadow:0 0 0 2px #111 inset}

    /* 市场列背景色：给承载容器着色（不是小方块） */
    .mtick.M{background:#ffe766}
    .mtick.P{background:#2d6bff}
    .mtick.T{background:#d62828}
    .mtick.S{background:#5b9bd5}
    .mtick.B{background:#ef4444}
    .mtick.K{background:#1f7a4d}
    .mtick.W{background:#3b82f6}
    .mtick.H{background:#ffcf5a}
    .mtick.E{background:#f0ad4e}

    /* 顶部市场图例（彩底+字母） */
    .legend-chip{display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;border-radius:6px;height:22px}
    .legend-chip.M{background:#ffe766}.legend-chip.P{background:#2d6bff;color:#fff}
    .legend-chip.T{background:#d62828;color:#fff}.legend-chip.S{background:#5b9bd5}
    .legend-chip.B{background:#ef4444;color:#fff}.legend-chip.K{background:#1f7a4d;color:#fff}
    .legend-chip.W{background:#3b82f6;color:#fff}.legend-chip.H{background:#ffcf5a}.legend-chip.E{background:#f0ad4e}

    .sumcell{min-width:74px;text-align:right;padding-right:8px}
    label{user-select:none;-webkit-user-select:none}

    /* —— 手机（≤768px） —— */
    @media (max-width: 768px){
      body{padding-bottom:70px}
      th,td{padding:4px 6px}
      input[type="text"]{width:48px}
      input[type="number"]{width:64px}
      .slots-head{grid-template-columns:repeat(15,28px);gap:4px}
      .slots-row{grid-auto-columns:28px;gap:4px}
      .slot{width:28px;height:24px}
      .slot .box{width:20px;height:18px}
      .m-legend{grid-template-columns:repeat(9,28px);gap:4px}
      .mgrid{grid-auto-columns:28px;gap:4px}
      .mtick{width:28px;height:24px}
      .mbox{width:16px;height:16px}
      .headbar.slots{grid-template-columns:repeat(15,28px)}
      .headbar.markets{grid-template-columns:repeat(9,28px)}
    }
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h1>下注页面</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat,msg in messages %}
        <div class="flash {{cat}}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" id="betForm">
    <input type="hidden" name="date" value="{{ date }}">

    <div class="table-wrap">
      <table id="betTable">
        <thead class="sticky-head">
        <tr>
          <th style="width:38px">#</th>
          <th style="width:82px">下注号码</th>
          <th>N1</th>
          <th>N</th>
          <th>BIG</th>
          <th>SMALL</th>
          <th>ODD</th>
          <th>EVEN</th>

          <!-- 时间段表头：09~23 + 顶部列控制（小格子） + 套用首行 -->
          <th>
            <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap">
              <div>下注时间段（当日 9–23）</div>
              <label class="muted" style="font-size:12px"><input type="checkbox" id="copySlots"> 套用首行</label>
            </div>
            <div class="slots-head" style="margin-top:6px">
              {% for s in slots %}<div>{{ "%02d"|format(s.hour) }}</div>{% endfor %}
            </div>
            <!-- 顶部每列一个控制小格子：点它 = 整列全选/全不选 -->
            <div class="headbar slots" id="headSlots">
              {% for s in slots %}
                <label class="headbox"><input type="checkbox" data-col="{{ loop.index0 }}"><span></span></label>
              {% endfor %}
            </div>
          </th>

          <!-- 市场表头：图例（彩底+字母） + 顶部列控制 + 套用首行 -->
          <th>
            <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap">
              <div>市场</div>
              <label class="muted" style="font-size:12px"><input type="checkbox" id="copyMarkets"> 套用首行</label>
            </div>
            <div class="m-legend" style="margin-top:6px">
              {% for m in markets %}
                <div class="legend-chip {{m}}" title="{{m}}">{{ m }}</div>
              {% endfor %}
            </div>
            <div class="headbar markets" id="headMarkets">
              {% for m in markets %}
                <label class="headbox"><input type="checkbox" data-col="{{ loop.index0 }}"><span></span></label>
              {% endfor %}
            </div>
          </th>

          <th style="width:88px">总额</th>
        </tr>
        </thead>

        <tbody>
        {% for i in range(10) %}
          <tr>
            <td>{{ i+1 }}</td>
            <td>
              <input name="number[]" type="text" maxlength="2" inputmode="numeric" pattern="[0-9]*" placeholder="">
            </td>
            <td><input name="amount_n1[]"    type="number" step="0.01" min="0" inputmode="decimal"></td>
            <td><input name="amount_n[]"     type="number" step="0.01" min="0" inputmode="decimal"></td>
            <td><input name="amount_big[]"   type="number" step="0.01" min="0" inputmode="decimal"></td>
            <td><input name="amount_small[]" type="number" step="0.01" min="0" inputmode="decimal"></td>
            <td><input name="amount_odd[]"   type="number" step="0.01" min="0" inputmode="decimal"></td>
            <td><input name="amount_even[]"  type="number" step="0.01" min="0" inputmode="decimal"></td>

            <!-- 时间段：滑动小方块 -->
            <td>
              <div class="slots-row">
                {% for s in slots %}
                  <label class="slot {{ 'locked' if s.locked else '' }}">
                    <input type="checkbox" name="slot_{{ i }}[]" value="{{ s.code }}" {% if s.locked %}disabled{% endif %} aria-label="{{ '%02d'|format(s.hour) }}:50">
                    <span class="box"></span>
                  </label>
                {% endfor %}
              </div>
            </td>

            <!-- 市场：彩列背景 + 白格 -->
            <td>
              <div class="mgrid">
                {% for m in markets %}
                  <label class="mtick {{m}}" title="{{m}}">
                    <input type="checkbox" name="market_{{ i }}[]" value="{{ m }}" aria-label="{{ m }}">
                    <span class="mbox"></span>
                  </label>
                {% endfor %}
              </div>
            </td>

            <td class="sumcell">0.00</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- 手机底部固定工具条 -->
    <div class="toolbar">
      <button type="button" class="btn" onclick="addRows(5)">+ 再加 5 行</button>
      <button type="submit" class="btn primary">提交</button>
      <a class="btn" href="/2d/history">当日注单</a>
      <a class="btn" href="/2d/winning">查看中奖</a>
    </div>
  </form>

<script>
(function(){
  const table = document.getElementById('betTable');
  const tbody = table.querySelector('tbody');
  const copySlots = document.getElementById('copySlots');
  const copyMarkets = document.getElementById('copyMarkets');
  const form = document.getElementById('betForm');

  // —— 视觉兜底：把 :checked 同步成 .on 类 —— //
  function syncRowVisual(tr){
    tr.querySelectorAll('label.slot').forEach(lbl=>{
      const cb = lbl.querySelector('input[type="checkbox"]');
      lbl.classList.toggle('on', !!(cb && cb.checked));
    });
    tr.querySelectorAll('label.mtick').forEach(lbl=>{
      const cb = lbl.querySelector('input[type="checkbox"]');
      lbl.classList.toggle('on', !!(cb && cb.checked));
    });
  }
  function syncAll(){ tbody.querySelectorAll('tr').forEach(syncRowVisual); }

  // —— 顶部“列控制”：时间段 —— //
  document.getElementById('headSlots').addEventListener('change', (e)=>{
    if (e.target.tagName !== 'INPUT') return;
    const col = +e.target.dataset.col;
    const checked = e.target.checked;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const slotLbl = tr.querySelectorAll('.slots-row .slot')[col];
      if(!slotLbl) return;
      const cb = slotLbl.querySelector('input[type="checkbox"]');
      if (cb && !cb.disabled){ cb.checked = checked; cb.dispatchEvent(new Event('change',{bubbles:true})); }
    });
  });

  // —— 顶部“列控制”：市场 —— //
  document.getElementById('headMarkets').addEventListener('change', (e)=>{
    if (e.target.tagName !== 'INPUT') return;
    const col = +e.target.dataset.col;
    const checked = e.target.checked;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const mLbl = tr.querySelectorAll('.mgrid .mtick')[col];
      if(!mLbl) return;
      const cb = mLbl.querySelector('input[type="checkbox"]');
      if (cb){ cb.checked = checked; cb.dispatchEvent(new Event('change',{bubbles:true})); }
    });
  });

  function recalcRow(tr){
    const names = ['amount_n1[]','amount_n[]','amount_big[]','amount_small[]','amount_odd[]','amount_even[]'];
    let sum = 0;
    names.forEach(n=>{
      const el = tr.querySelector(`input[name="${n}"]`);
      if(!el) return;
      const v = parseFloat(el.value);
      if(!isNaN(v)) sum += v;
    });
    tr.querySelector('.sumcell').textContent = sum.toFixed(2);
  }
  function getRow(idx){ return tbody.children[idx]; }

  function applySlotsFromFirst(){
    const first = getRow(0); if(!first) return;
    const selected = Array.from(first.querySelectorAll('input[type="checkbox"][name^="slot_"]')).filter(cb=>cb.checked).map(cb=>cb.value);
    for(let i=1;i<tbody.children.length;i++){
      const boxes = getRow(i).querySelectorAll('input[type="checkbox"][name^="slot_"]');
      boxes.forEach(cb=>{ if(!cb.disabled) cb.checked = selected.includes(cb.value); });
      syncRowVisual(getRow(i));
    }
  }
  function applyMarketsFromFirst(){
    const first = getRow(0); if(!first) return;
    const selected = Array.from(first.querySelectorAll('input[type="checkbox"][name^="market_"]')).filter(cb=>cb.checked).map(cb=>cb.value);
    for(let i=1;i<tbody.children.length;i++){
      const boxes = getRow(i).querySelectorAll('input[type="checkbox"][name^="market_"]');
      boxes.forEach(cb=>{ cb.checked = selected.includes(cb.value); });
      syncRowVisual(getRow(i));
    }
  }

  // 行内变化
  tbody.addEventListener('change', e=>{
    const tr = e.target.closest('tr'); if(!tr) return;
    syncRowVisual(tr);
    const isFirst = tr === getRow(0);
    if(isFirst && copySlots.checked && e.target.name.startsWith('slot_')) applySlotsFromFirst();
    if(isFirst && copyMarkets.checked && e.target.name.startsWith('market_')) applyMarketsFromFirst();
  });

  // 合计
  tbody.addEventListener('input', e=>{ const tr = e.target.closest('tr'); if(tr) recalcRow(tr); });
  tbody.querySelectorAll('tr').forEach(recalcRow);

  // 加行
  window.addRows = function(n){
    for(let k=0;k<n;k++){
      const clone = tbody.lastElementChild.cloneNode(true);
      clone.querySelectorAll('input').forEach(inp=>{
        if(inp.type === 'checkbox') inp.checked = false; else inp.value = '';
      });
      const idx = tbody.children.length;
      clone.children[0].textContent = idx+1;
      clone.querySelectorAll('input[type="checkbox"][name^="slot_"]').forEach(cb=>cb.name = `slot_${idx}[]`);
      clone.querySelectorAll('input[type="checkbox"][name^="market_"]').forEach(cb=>cb.name = `market_${idx}[]`);
      clone.querySelector('.sumcell').textContent = '0.00';
      tbody.appendChild(clone);
      syncRowVisual(clone);
    }
  }

  // 兜底点击：点到 .slot/.mtick 任意位置切换；若直接点到 input 则不重复切换
  document.addEventListener('click', function(e){
    if (e.target.matches('.slot input, .mtick input, .headbox input')) return;
    const block = e.target.closest('.slot, .mtick');
    if(!block) return;
    const cb = block.querySelector('input[type="checkbox"]');
    if(cb && !cb.disabled){
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change', {bubbles:true}));
      syncRowVisual(block.closest('tr'));
    }
  }, {passive:true});

  // 提交前简单校验（可保留/可删）
  document.getElementById('betForm').addEventListener('submit', function(e){
    const rows = Array.from(document.querySelectorAll('#betTable tbody tr'));
    let validLine = 0;
    for (const tr of rows){
      const num = (tr.querySelector('input[name="number[]"]')?.value || '').trim();
      const amounts = ['amount_n1[]','amount_n[]','amount_big[]','amount_small[]','amount_odd[]','amount_even[]']
        .map(n => parseFloat(tr.querySelector(`input[name="${n}"]`)?.value || '0') || 0)
        .reduce((a,b)=>a+b,0);
      if (!num && amounts===0) continue; // 空行允许
      if (!/^\d{1,2}$/.test(num)) { alert('号码必须是 0-99 的两位数（可填 0 或 00）。'); e.preventDefault(); return; }
      const slots = tr.querySelectorAll('input[name^="slot_"]:checked').length;
      const mkts  = tr.querySelectorAll('input[name^="market_"]:checked').length;
      if (slots===0 || mkts===0) { alert('请选择至少一个时间段和一个市场。'); e.preventDefault(); return; }
      validLine++;
    }
    if (validLine===0) { alert('没有可提交的有效行。'); e.preventDefault(); }
  });

  // 初始化一次视觉
  syncAll();
})();
</script>
</body>
</html>
