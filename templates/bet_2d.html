<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>2D 下注（与 4D 同版式）</title>
  <style>
    :root{
      --c-border:#d0d7de; --c-head:#f6f8fa; --c-muted:#666;
      /* 市场配色与 4D 一致 */
      --M:#ffff00; --P:#0000ff; --T:#cc0000; --S:#4c8ed1;
      --B:#e51d20; --K:#008835; --W:#00540e; --H:#fed606; --E:#ffa500; --sel:#2d6bff;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif; padding:12px}
    h1,h2{margin:0 0 12px}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--c-border);border-radius:10px;overflow:hidden}
    th,td{border:1px solid var(--c-border);padding:6px 8px;text-align:center}
    thead th{background:var(--c-head)}
    tfoot td{background:#fafbfc}
    input[type="text"]{text-align:center}
    input.money{width:64px;text-align:right}

    /* 顶部金额列“复制向下”总控小方块（风格与 4D 页面一致） */
    .headbox{position:relative;display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center;border-radius:6px}
    .headbox input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .headbox span{width:16px;height:16px;background:#fff;border:1px solid var(--c-border);border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;pointer-events:none}
    .headbox input:checked + span{box-shadow:0 0 0 2px #111 inset;background:#e8f0ff}
    .headbox input:checked + span::after{content:"✓";display:block;text-align:center;font-weight:700;font-size:12px;line-height:16px;color:#111}

    /* 市场表头颜色块（与 4D 相同） */
    .Mbg{background:var(--M)} .Pbg{background:var(--P)} .Tbg{background:var(--T)}
    .Sbg{background:var(--S)} .Bbg{background:var(--B)} .Kbg{background:var(--K)}
    .Wbg{background:var(--W)} .Hbg{background:var(--H)} .Ebg{background:var(--E)}

    /* 市场单元格：彩色底 + 内部白色小方块（与 4D 同风格） */
    .mtick{position:relative;display:block;width:100%;height:34px; /* 充满整格 */
      align-items:center;justify-content:center;border-radius:4px;border:2px solid #fff;
      box-shadow:0 0 0 1px rgba(0,0,0,.28) inset;margin:auto}
    .mtick.M{background:var(--M)}
    .mtick.P{background:var(--P)}
    .mtick.T{background:var(--T)}
    .mtick.S{background:var(--S)}
    .mtick.B{background:var(--B)}
    .mtick.K{background:var(--K)}
    .mtick.W{background:var(--W)}
    .mtick.H{background:var(--H)}
    .mtick.E{background:var(--E)}
    /* 勾选后整格变为高亮蓝色 */
    

    .mtick input{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:2}
    .mbox{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:20px;height:18px;background:#fff;border-radius:6px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset;pointer-events:none;z-index:1}
    .mtick input:checked + .mbox{background:var(--sel);border-color:var(--sel);box-shadow:none}
    .mtick input:checked + .mbox::after{content:"✓";font-weight:700;font-size:14px;line-height:16px;color:#fff;display:block;text-align:center}

    /* 统一列宽，避免“排列乱位” */
    .num-col{width:86px}
    .amt-col{width:72px}
    .slot-head,.slot-cell{width:46px}
    .market-head,.market-cell{width:46px}

    /* 单元格里的复选框尺寸统一 */
    .ck{width:18px;height:18px}

    /* 手机优化 */
    @media (max-width: 768px){
      .amt-col{width:62px}
      .slot-head,.slot-cell,.market-head,.market-cell{width:42px}
      input.money{width:56px}
    }
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h2>下注页面（2D，版式对齐 4D）</h2>

  <form method="post" id="betForm" onsubmit="return handleBet();">
    <input type="hidden" name="date" value="{{ date }}">

    <table>
      <thead>
      <tr>
        <th rowspan="2">#</th>
        <th rowspan="2" class="num-col">下注号码</th>

        <!-- 六类金额，与 4D 的 B/S/A/C 一致做“复制向下”总控 -->
        <th rowspan="2" class="amt-col">
          N1<br>
          <label class="headbox"><input type="checkbox" id="fillN1" onclick="copyAmountDown('N1', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          N<br>
          <label class="headbox"><input type="checkbox" id="fillN" onclick="copyAmountDown('N', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          BIG<br>
          <label class="headbox"><input type="checkbox" id="fillBIG" onclick="copyAmountDown('BIG', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          SMALL<br>
          <label class="headbox"><input type="checkbox" id="fillSMALL" onclick="copyAmountDown('SMALL', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          ODD<br>
          <label class="headbox"><input type="checkbox" id="fillODD" onclick="copyAmountDown('ODD', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          EVEN<br>
          <label class="headbox"><input type="checkbox" id="fillEVEN" onclick="copyAmountDown('EVEN', this.checked)"><span></span></label>
        </th>

        <th colspan="15">下注时间段（当日 09–23）</th>
        <th colspan="9">市场</th>
        <th rowspan="2">总额</th>
      </tr>
      <tr>
        {# —— 时间段表头：每列一个“总控”复选 + 时刻 —— #}
        {% set slots = [9,10,11,12,13,14,15,16,17,18,19,20,21,22,23] %}
        {% for h in slots %}
          <th class="slot-head">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox"><input type="checkbox" id="select_slot_{{ loop.index0 }}" onclick="toggleColumn('slot', {{ loop.index0 }})"><span></span></label>
              <small class="muted">{{ "%02d"|format(h) }}</small>
            </div>
          </th>
        {% endfor %}

        {# —— 市场表头（彩色块 + 总控） —— #}
        {% set market_order = ['M','P','T','S','B','K','W','H','E'] %}
        {% for m in market_order %}
          <th class="market-head {{ m }}bg">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox"><input type="checkbox" id="select_market_{{ m }}" onclick="toggleColumn('market', '{{ m }}')"><span></span></label>
              <strong style="color:#111">{{ m }}</strong>
            </div>
          </th>
        {% endfor %}
      </tr>
      </thead>

      <tbody>
      {% for i in range(1, 13) %}
        <tr>
          <td>{{ i }}</td>
          <td class="num-col">
            <input type="text" name="number{{ i }}" maxlength="2" inputmode="numeric" pattern="[0-9]{2}"
                   oninput="this.value=this.value.replace(/[^0-9]/g,'')" style="width:80px">
          </td>

          <td class="amt-col"><input class="money" type="text" name="N1{{ i }}"   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="N{{ i }}"    inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="BIG{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="SMALL{{ i }}"inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="ODD{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="EVEN{{ i }}" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>

          {# —— 时间段列（每格一个 checkbox） —— #}
          {% for h in slots %}
            <td class="slot-cell">
              <input class="ck slot_col_{{ loop.index0 }}" type="checkbox" name="slot{{ i }}_{{ loop.index0 }}">
            </td>
          {% endfor %}

          {# —— 市场列 —— #}
          {% for m in market_order %}
            <td class="market-cell {{ m }}bg">
              <input class="ck market_col_{{ m }}" type="checkbox" name="market{{ i }}_{{ m }}">
            </td>
          {% endfor %}

          <td><span class="row-total">0.00</span></td>
        </tr>
      {% endfor %}
      </tbody>

      <tfoot>
      <tr>
        <td colspan="28" style="text-align:right;font-weight:bold">总下注金额：RM <span id="grand-total">0.00</span></td>
      </tr>
      </tfoot>
    </table>

    <div style="margin-top:10px">
      <button type="submit" style="font-size:16px;padding:8px 16px">提交</button>
      <button type="reset"  style="font-size:16px;padding:8px 16px">清除</button>
    </div>
  </form>

<script>
/**************** 金额“复制向下” ****************/
function copyAmountDown(col, checked){
  const first = document.querySelector(`input[name="${col}1"]`);
  const v = first ? first.value : '';
  for(let i=2;i<=12;i++){
    const el = document.querySelector(`input[name="${col}${i}"]`);
    if(!el) continue;
    el.value = checked ? v : '';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  updateTotals();
}

/**************** 列总控：时间段/市场 ****************/
function toggleColumn(type, key){
  if(type==='slot'){
    const state = document.getElementById(`select_slot_${key}`).checked;
    document.querySelectorAll(`.slot_col_${key}`).forEach(cb=>cb.checked = state);
  }
  if(type==='market'){
    const state = document.getElementById(`select_market_${key}`).checked;
    document.querySelectorAll(`.market_col_${key}`).forEach(cb=>cb.checked = state);
  }
  updateTotals();
}

/**************** 计算总额（与 4D 同思路，2D 的 6 类金额） ****************/
function updateTotals(){
  let grand = 0;
  const SLOT_COUNT = {{ slots|length if slots is defined else 15 }}; // 容错
  const MARKET_ORDER = ['M','P','T','S','B','K','W','H','E'];

  for(let i=1;i<=12;i++){
    const N1   = parseFloat(document.querySelector(`input[name="N1${i}"]`)?.value)||0;
    const N    = parseFloat(document.querySelector(`input[name="N${i}"]`)?.value)||0;
    const BIG  = parseFloat(document.querySelector(`input[name="BIG${i}"]`)?.value)||0;
    const SMALL= parseFloat(document.querySelector(`input[name="SMALL${i}"]`)?.value)||0;
    const ODD  = parseFloat(document.querySelector(`input[name="ODD${i}"]`)?.value)||0;
    const EVEN = parseFloat(document.querySelector(`input[name="EVEN${i}"]`)?.value)||0;

    let slotCount = 0; for(let s=0;s<15;s++){ const cb = document.querySelector(`input[name="slot${i}_$${'{'}s{'}'}"]`); if(cb?.checked) slotCount++; }
    // 上面一行因模板转义写法较难，用类选择器统计：
    slotCount = Array.from(document.querySelectorAll(`[name^=slot${i}_]`)).filter(x=>x.checked).length;

    let marketCount = 0; for(const m of MARKET_ORDER){ const cb = document.querySelector(`input[name="market${i}_${m}"]`); if(cb?.checked) marketCount++; }

    const base = N1 + N + BIG + SMALL + ODD + EVEN;
    const rowTotal = base * slotCount * marketCount;
    const cell = document.querySelectorAll('.row-total')[i-1];
    if(cell) cell.textContent = rowTotal.toFixed(2);
    grand += rowTotal;
  }
  const g = document.getElementById('grand-total'); if(g) g.textContent = grand.toFixed(2);
}

/**************** 提交前确认（简版，与 4D 一致风格） ****************/
function handleBet(){
  updateTotals();
  const grand = parseFloat(document.getElementById('grand-total').textContent)||0;
  return confirm(`下注总金额 = RM ${grand.toFixed(2)}
确认下注？`);
}

/**************** 初始化监听 ****************/
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('input[type="text"]').forEach(el=>{
    el.addEventListener('input', updateTotals);
  });
  document.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', updateTotals);
  });
  updateTotals();
});
</script>
</body>
</html>
