{% extends "layout.html" %}

{% block title %}2D 下注{% endblock %}
{% block header_title %}下注页面{% endblock %}

{# 右侧：管理员选择代理（仅显示数字 ID） #}
{% block header_actions %}
  {% if session.get('role') == 'admin' %}
  <div class="admin-agent" style="margin-left:auto;display:flex;align-items:center;gap:8px;font-size:14px;">
    <label for="agentSelect">下注代理：</label>
    <select id="agentSelect" name="agent_id" form="betForm"
            style="height:34px;padding:4px 8px;border:1px solid #d0d7de;border-radius:8px;background:#fff;">
      {% for a in (agents or []) %}
        <option value="{{ a.id }}" {% if a.id == (selected_agent_id or 1) %}selected{% endif %}>
          {{ a.username }}
        </option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
{% endblock %}

{% block head_extra %}
<style>
  :root{
    --c-border:#d0d7de; --c-head:#f6f8fa;
    --M:#ffff00; --P:#0000ff; --T:#cc0000; --S:#4c8ed1;
    --B:#e51d20; --K:#008835; --W:#00540e; --H:#fed606; --E:#ffa500;
  }
  table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--c-border);border-radius:10px;overflow:hidden}
  th,td{border:1px solid var(--c-border);padding:6px 8px;text-align:center}
  thead th{background:var(--c-head)}
  tfoot td{background:#fafbfc}
  input[type="text"]{text-align:center}
  input.money{width:64px;text-align:right}
  .headbox{position:relative;display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center;border-radius:6px}
  .headbox input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .headbox span{width:16px;height:16px;background:#fff;border:1px solid var(--c-border);border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;pointer-events:none}
  .headbox input:checked + span{box-shadow:0 0 0 2px #111 inset;background:#e8f0ff}
  .headbox input:checked + span::after{content:"✓";display:block;text-align:center;font-weight:700;font-size:12px;line-height:16px;color:#111}
  .Mbg{background:var(--M)} .Pbg{background:var(--P)} .Tbg{background:var(--T)}
  .Sbg{background:var(--S)} .Bbg{background:var(--B)} .Kbg{background:var(--K)}
  .Wbg{background:var(--W)} .Hbg{background:var(--H)} .Ebg{background:var(--E)}
  .num-col{width:86px}
  .amt-col{width:72px}
  .slot-head,.slot-cell{width:46px}
  .market-head,.market-cell{width:46px}
  .ck{width:18px;height:18px}

  /* 置灰不可用的时间段整列 */
  .slot-disabled { opacity:.45; filter:grayscale(100%); }
  .slot-cell input:disabled{ cursor:not-allowed }
  .slot-head input:disabled{ cursor:not-allowed }

  @media (max-width: 768px){
    .amt-col{width:62px}
    .slot-head,.slot-cell,.market-head,.market-cell{width:42px}
    input.money{width:56px}
  }
</style>
{% endblock %}

{% block content %}
<form method="post" id="betForm" onsubmit="return handleBet();">
  <input type="hidden" name="date" value="{{ date }}">

  <table>
    <thead>
      <tr>
        <th rowspan="2">#</th>
        <th rowspan="2" class="num-col">下注号码</th>
        <th rowspan="2" class="amt-col">
          N1<br>
          <label class="headbox"><input type="checkbox" id="fillN1" onclick="copyAmountDown('N1', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          N<br>
          <label class="headbox"><input type="checkbox" id="fillN" onclick="copyAmountDown('N', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          BIG<br>
          <label class="headbox"><input type="checkbox" id="fillBIG" onclick="copyAmountDown('BIG', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          SMALL<br>
          <label class="headbox"><input type="checkbox" id="fillSMALL" onclick="copyAmountDown('SMALL', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          ODD<br>
          <label class="headbox"><input type="checkbox" id="fillODD" onclick="copyAmountDown('ODD', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          EVEN<br>
          <label class="headbox"><input type="checkbox" id="fillEVEN" onclick="copyAmountDown('EVEN', this.checked)"><span></span></label>
        </th>

        <th colspan="15">下注时间段（当日 09–23）</th>
        <th colspan="9">市场</th>
        <th rowspan="2">总额</th>
      </tr>
      <tr>
        {% set slots = [9,10,11,12,13,14,15,16,17,18,19,20,21,22,23] %}
        {% for h in slots %}
          <th class="slot-head" data-slot-idx="{{ loop.index0 }}" data-slot-hour="{{ h }}">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox">
                <input type="checkbox" id="select_slot_{{ loop.index0 }}" onclick="toggleColumn('slot', {{ loop.index0 }})"><span></span>
              </label>
              <small class="muted">{{ "%02d"|format(h) }}</small>
            </div>
          </th>
        {% endfor %}
        {% set market_order = ['M','P','T','S','B','K','W','H','E'] %}
        {% for m in market_order %}
          <th class="market-head {{ m }}bg">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox"><input type="checkbox" id="select_market_{{ m }}" onclick="toggleColumn('market', '{{ m }}')"><span></span></label>
              <strong style="color:#111">{{ m }}</strong>
            </div>
          </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for i in range(1, 12+1) %}
      <tr>
        <td>{{ i }}</td>
        <td class="num-col">
          <input type="text" name="number{{ i }}" maxlength="2" inputmode="numeric" pattern="[0-9]{2}"
                 oninput="this.value=this.value.replace(/[^0-9]/g,'')" style="width:80px">
        </td>

        <td class="amt-col"><input class="money" type="text" name="N1{{ i }}"   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
        <td class="amt-col"><input class="money" type="text" name="N{{ i }}"    inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
        <td class="amt-col"><input class="money" type="text" name="BIG{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
        <td class="amt-col"><input class="money" type="text" name="SMALL{{ i }}"inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
        <td class="amt-col"><input class="money" type="text" name="ODD{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
        <td class="amt-col"><input class="money" type="text" name="EVEN{{ i }}" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>

        {% for h in slots %}
          <td class="slot-cell" data-slot-idx="{{ loop.index0 }}" data-slot-hour="{{ h }}">
            <input class="ck slot_col_{{ loop.index0 }}" type="checkbox" name="slot{{ i }}_{{ loop.index0 }}">
          </td>
        {% endfor %}

        {% for m in market_order %}
          <td class="market-cell {{ m }}bg">
            <input class="ck market_col_{{ m }}" type="checkbox" name="market{{ i }}_{{ m }}">
          </td>
        {% endfor %}

        <td><span class="row-total">0.00</span></td>
      </tr>
      {% endfor %}
    </tbody>

    <tfoot>
      <tr>
        <td colspan="33" style="text-align:right;font-weight:bold">总下注金额：RM <span id="grand-total">0.00</span></td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top:10px">
    <button type="submit" style="font-size:16px;padding:8px 16px">提交</button>
    <button type="reset"  style="font-size:16px;padding:8px 16px">清除</button>
  </div>
</form>
{% endblock %}

{% block body_extra %}
<script>
/**************** 金额“复制向下” ****************/
function copyAmountDown(col, checked){
  const first = document.querySelector(`input[name="${col}1"]`);
  const v = first ? first.value : '';
  for(let i=2;i<=12;i++){
    const el = document.querySelector(`input[name="${col}${i}"]`);
    if(!el) continue;
    el.value = checked ? v : '';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  updateTotals();
}

/**************** 列总控：时间段/市场 ****************/
function toggleColumn(type, key){
  if(type==='slot'){
    const head = document.getElementById(`select_slot_${key}`);
    if (head && head.disabled) return; // 被禁用的整列不响应
    const state = head.checked;
    document.querySelectorAll(`.slot_col_${key}`).forEach(cb=>{
      if(!cb.disabled) cb.checked = state;
    });
  }
  if(type==='market'){
    const state = document.getElementById(`select_market_${key}`).checked;
    document.querySelectorAll(`.market_col_${key}`).forEach(cb=>cb.checked = state);
  }
  updateTotals();
}

/**************** 计算总额 ****************/
function updateTotals(){
  let grand = 0;
  const rows = Array.from(document.querySelectorAll('#betForm tbody tr'));
  rows.forEach((tr, idx) => {
    const i = idx + 1;
    const getVal = (name) => parseFloat(tr.querySelector(`input[name="${name}${i}"]`)?.value) || 0;
    const base = getVal('N1') + getVal('N') + getVal('BIG') + getVal('SMALL') + getVal('ODD') + getVal('EVEN');
    const slotCount   = tr.querySelectorAll('.slot-cell   input[type="checkbox"]:checked').length;
    const marketCount = tr.querySelectorAll('.market-cell input[type="checkbox"]:checked').length;
    const rowTotal = base * slotCount * marketCount;
    const cell = tr.querySelector('.row-total'); if (cell) cell.textContent = rowTotal.toFixed(2);
    grand += rowTotal;
  });
  const g = document.getElementById('grand-total'); if (g) g.textContent = grand.toFixed(2);
}

/**************** 提交前确认 ****************/
function handleBet(){
  updateTotals();
  const grand = parseFloat(document.getElementById('grand-total').textContent)||0;
  const popup = buildBetPopupText();
  if (popup) localStorage.setItem('bet_popup', popup);
  return confirm(`下注总金额 = RM ${grand.toFixed(2)}\n确认下注？`);
}

/**************** 初始化、时间段锁定 ****************/
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('input[type="text"]').forEach(el=>el.addEventListener('input', updateTotals));
  document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change', updateTotals));
  applySlotLocks();   // 根据当前时间置灰/禁用
  updateTotals();

  // 成功弹窗（?success=1）
  const params = new URLSearchParams(location.search);
  if (params.get('success') === '1') {
    const saved = localStorage.getItem('bet_popup');
    if (saved) showBetPopup(saved);
    localStorage.removeItem('bet_popup');
    const url = new URL(location.href);
    url.searchParams.delete('success');
    history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ''));
  }
});

/* 灰掉已过锁注时间（当日每小时 49 分锁） */
function applySlotLocks(){
  const pageDateStr = document.querySelector('input[name="date"]')?.value; // YYYY-MM-DD
  if(!pageDateStr) return;

  // 以客户端本地时间为准：当天才逐列判断；过去日全部禁用；未来日全部可用
  const now = new Date();
  const [yy,mm,dd] = pageDateStr.split('-').map(n=>parseInt(n,10));
  const pageDate = new Date(yy, mm-1, dd);

  // 归零比较
  const dNow = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dPage = new Date(pageDate.getFullYear(), pageDate.getMonth(), pageDate.getDate());

  const isPastDay   = dPage.getTime() < dNow.getTime();
  const isFutureDay = dPage.getTime() > dNow.getTime();

  document.querySelectorAll('[data-slot-idx]').forEach(el=>{
    const idx = el.getAttribute('data-slot-idx');
    const hour = parseInt(el.getAttribute('data-slot-hour'),10);

    let shouldDisable = false;
    if (isPastDay) {
      shouldDisable = true;
    } else if (isFutureDay) {
      shouldDisable = false;
    } else {
      // 同一天：当日 hour:49 锁
      const lock = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 49, 0, 0);
      shouldDisable = now >= lock;
    }

    // 表头
    const headCk = document.getElementById(`select_slot_${idx}`);
    const headTh = document.querySelector(`.slot-head[data-slot-idx="${idx}"]`);
    if (headCk) {
      headCk.disabled = shouldDisable;
      if (shouldDisable) { headCk.checked = false; }
    }
    if (headTh) {
      headTh.classList.toggle('slot-disabled', shouldDisable);
    }

    // 整列单元格
    document.querySelectorAll(`.slot_col_${idx}`).forEach(cb=>{
      cb.disabled = shouldDisable;
      if (shouldDisable) cb.checked = false;
      const td = cb.closest('.slot-cell');
      if (td) td.classList.toggle('slot-disabled', shouldDisable);
    });
  });
}

function fmtNum(n){
  const v = Number(n);
  if (!isFinite(v)) return "0";
  return v.toFixed(2).replace(/\.?0+$/, "");
}

function buildBetPopupText(){
  const rows = Array.from(document.querySelectorAll('#betForm tbody tr'));
  const H_BASE = 9; // 09~23
  const MARKET_ORDER = ['M','P','T','S','B','K','W','H','E'];

  const slotSet   = new Set();
  const marketSet = new Set();
  const lines     = [];

  rows.forEach((tr, idx) => {
    const i = idx + 1;
    const number = tr.querySelector(`input[name="number${i}"]`)?.value?.trim() || "";
    if (!number) return;

    const parts = [];
    const pushIf = (key, label) => {
      const el = tr.querySelector(`input[name="${key}${i}"]`);
      if (!el) return;
      const v = parseFloat((el.value || "").trim());
      if (isFinite(v) && v > 0) parts.push(`${fmtNum(v)}${label}`);
    };
    pushIf("N1","N1"); pushIf("N","N"); pushIf("BIG","B");
    pushIf("SMALL","S"); pushIf("ODD","O"); pushIf("EVEN","E");
    if (!parts.length) return;

    tr.querySelectorAll('.slot-cell input[type="checkbox"]:checked').forEach(cb=>{
      const idx2 = parseInt(cb.name.split('_').pop(),10);
      if (!Number.isNaN(idx2)) slotSet.add(H_BASE + idx2);
    });
    MARKET_ORDER.forEach(m=>{
      if (tr.querySelector(`input[name="market${i}_${m}"]`)?.checked) marketSet.add(m);
    });

    lines.push(`${number} = ${parts.join(' ')}`);
  });

  const slotLine = Array.from(slotSet).sort((a,b)=>a-b)
    .map(h => String(h).padStart(2,'0')).join('-') || '-';
  const marketLine = '*' + (MARKET_ORDER.filter(m => marketSet.has(m)).join('') || '-');

  const grandRaw = parseFloat(document.getElementById('grand-total')?.textContent || '0');
  const gt = fmtNum(grandRaw);

  const out = [slotLine, marketLine];
  if (lines.length) out.push(...lines);
  out.push('', `GT=${gt}`);
  return out.join('\n');
}

function showBetPopup(text) {
  if (!text) return;
  const old = document.getElementById("resultModal"); if (old) old.remove();
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div id="resultModal" style="position:fixed; top:20px; left:10px; right:10px; background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.15); padding:16px; z-index:9999; max-width:420px; margin:auto; font-family:system-ui, sans-serif;">
      <div id="resultText" style="white-space:pre-wrap; word-break:break-word; margin-bottom:16px; font-size:14px;">${text}</div>
      <div style="display:flex; gap:10px;">
        <button onclick="copyResult()" style="flex:1; padding:8px; background:#007bff; color:#fff; border:0; border-radius:8px;">复制</button>
        <button onclick="confirmResult()" style="flex:1; padding:8px; background:#28a745; color:#fff; border:0; border-radius:8px;">确认</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  window.scrollTo({top:0, behavior:'smooth'});
}
function copyResult(){
  const text = document.getElementById('resultText')?.innerText || '';
  if (!text) return;
  navigator.clipboard.writeText(text).then(()=>alert('✅ 已复制下注信息')).catch(()=>alert('❌ 复制失败，请手动选择文字'));
}
function confirmResult(){ document.getElementById('resultModal')?.remove(); }
</script>
{% endblock %}
