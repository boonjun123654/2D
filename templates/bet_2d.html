<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>2D 下注</title>
  <style>
    :root{
      --c-border:#d0d7de; --c-head:#f6f8fa; --c-muted:#666;
      --c-blue:#1f6feb; --c-red:#b91c1c; --c-green:#0f5132; --c-yellow:#ffd400; --c-orange:#f0ad4e;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif; padding:20px;}
    h1{margin:0 0 12px}
    .muted{color:var(--c-muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
    .btn{padding:6px 12px;border:1px solid var(--c-border);background:#fff;border-radius:6px;cursor:pointer}
    .btn.primary{background:#0969da;color:#fff;border-color:#0969da}
    .flash{padding:10px;border-radius:8px;margin:10px 0}
    .flash.ok{background:#e6ffed;border:1px solid #79d27d}
    .flash.error{background:#ffe6e6;border:1px solid #ff9999}

    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid var(--c-border);padding:6px 8px;font-size:14px;text-align:center}
    th{background:var(--c-head)}
    .sticky-head th{position:sticky;top:0;background:var(--c-head);z-index:1}

    /* 像4D那样紧凑的输入格子 */
    input[type="text"]{width:64px;text-align:center}
    input[type="number"]{width:84px;text-align:right}

    /* 市场彩色方块（接近4D风格） */
    .mgrid{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;min-width:260px}
    .mbox{display:flex;align-items:center;justify-content:center;gap:6px;padding:6px 0;border-radius:8px;color:#fff;font-weight:700}
    .mbox input{transform:scale(1.1)}
    .M{background:var(--c-yellow); color:#111}
    .P{background:var(--c-blue)}
    .T{background:var(--c-red)}
    .S{background:#5b9bd5}
    .B{background:var(--c-red)}
    .K{background:var(--c-green)}
    .W{background:var(--c-blue)}
    .H{background:#ffce54; color:#111}
    .E{background:var(--c-orange); color:#111}

    /* 时间段横向9~23（每小时一个checkbox） */
    .slots-row{display:grid;grid-template-columns:repeat(15, minmax(40px, 1fr));gap:6px}
    .slot{display:flex;align-items:center;justify-content:center;gap:6px;padding:6px 0;border:1px dashed transparent;border-radius:8px}
    .slot.locked{opacity:.4}
    .sumcell{min-width:90px;text-align:right;padding-right:10px}

    .tiny{font-size:12px}
    .hdr-copy{display:flex;align-items:center;justify-content:center;gap:6px}
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h1>下注页面</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat,msg in messages %}
        <div class="flash {{cat}}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="get" class="controls">
    <label>选择日期：</label>
    <input type="date" name="date" value="{{ date }}">
    <button class="btn">切换</button>
    <span class="muted">当前时间：{{ now }}</span>
  </form>

  <form method="post" id="betForm">
    <input type="hidden" name="date" value="{{ date }}">
    <div class="controls">
      <button type="submit" class="btn primary">提交</button>
      <a class="btn" href="/2d/history">查看当日注单</a>
      <a class="btn" href="/2d/winning">查看中奖</a>
    </div>

    <table id="betTable">
      <thead class="sticky-head">
      <tr>
        <th style="width:44px">#</th>
        <th style="width:90px">下注号码</th>
        <th>N1</th>
        <th>N</th>
        <th>BIG</th>
        <th>SMALL</th>
        <th>ODD</th>
        <th>EVEN</th>

        <!-- 时间段表头：横向 9~23 + “套用首行”小勾 -->
        <th>
          <div class="hdr-copy">
            <span>下注时间段（当日 9–23）</span>
            <label class="tiny"><input type="checkbox" id="copySlots"> 套用首行</label>
          </div>
          <div class="tiny muted">每格代表该小时 <b>:50</b>；已过锁点会置灰</div>
          <div class="slots-row tiny" style="margin-top:6px">
            {% for s in slots %}
              <div>{{ "%02d"|format(s.hour) }}</div>
            {% endfor %}
          </div>
        </th>

        <!-- 市场表头：彩色方块 + “套用首行” -->
        <th>
          <div class="hdr-copy">
            <span>市场</span>
            <label class="tiny"><input type="checkbox" id="copyMarkets"> 套用首行</label>
          </div>
          <div class="mgrid tiny" style="margin-top:6px">
            {% for m in markets %}
              <div class="mbox {{m}}">{{ m }}</div>
            {% endfor %}
          </div>
        </th>

        <th style="width:110px">总额</th>
      </tr>
      </thead>

      <tbody>
      {% for i in range(10) %}
        <tr>
          <td>{{ i+1 }}</td>
          <td><input name="number[]" type="text" maxlength="2" placeholder=""></td>
          <td><input name="amount_n1[]"    type="number" step="0.01" min="0"></td>
          <td><input name="amount_n[]"     type="number" step="0.01" min="0"></td>
          <td><input name="amount_big[]"   type="number" step="0.01" min="0"></td>
          <td><input name="amount_small[]" type="number" step="0.01" min="0"></td>
          <td><input name="amount_odd[]"   type="number" step="0.01" min="0"></td>
          <td><input name="amount_even[]"  type="number" step="0.01" min="0"></td>

          <!-- 时间段：9–23 横排 -->
          <td>
            <div class="slots-row">
              {% for s in slots %}
                <label class="slot {{ 'locked' if s.locked else '' }}">
                  <input type="checkbox" name="slot_{{ i }}[]" value="{{ s.code }}" {% if s.locked %}disabled{% endif %}>
                  {{ "%02d"|format(s.hour) }}
                </label>
              {% endfor %}
            </div>
          </td>

          <!-- 市场：彩色方块 -->
          <td>
            <div class="mgrid">
              {% for m in markets %}
                <label class="mbox {{m}}" title="{{m}}">
                  <input type="checkbox" name="market_{{ i }}[]" value="{{ m }}">
                  {{ m }}
                </label>
              {% endfor %}
            </div>
          </td>

          <td class="sumcell">0.00</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <div class="controls">
      <button type="button" class="btn" onclick="addRows(5)">+ 再加 5 行</button>
      <button type="submit" class="btn primary">提交</button>
    </div>
  </form>

<script>
(function(){
  const table = document.getElementById('betTable');
  const tbody = table.querySelector('tbody');
  const copySlots = document.getElementById('copySlots');
  const copyMarkets = document.getElementById('copyMarkets');

  function recalcRow(tr){
    const names = ['amount_n1[]','amount_n[]','amount_big[]','amount_small[]','amount_odd[]','amount_even[]'];
    let sum = 0;
    names.forEach(n=>{
      const el = tr.querySelector(`input[name="${n}"]`);
      if(!el) return;
      const v = parseFloat(el.value);
      if(!isNaN(v)) sum += v;
    });
    tr.querySelector('.sumcell').textContent = sum.toFixed(2);
  }

  function getRow(idx){ return tbody.children[idx]; }

  // 把首行的“时间段选择”复制到其它行（跳过 disabled 的格子）
  function applySlotsFromFirst(){
    const first = getRow(0);
    if(!first) return;
    const firstBoxes = first.querySelectorAll('input[type="checkbox"][name^="slot_"]');
    const selectedCodes = Array.from(firstBoxes).filter(cb=>cb.checked).map(cb=>cb.value);
    for(let i=1;i<tbody.children.length;i++){
      const row = getRow(i);
      const boxes = row.querySelectorAll('input[type="checkbox"][name^="slot_"]');
      boxes.forEach(cb=>{
        if(cb.disabled) return;                  // 已过锁点的不勾选
        cb.checked = selectedCodes.includes(cb.value);
      });
    }
  }

  // 把首行的“市场选择”复制到其它行
  function applyMarketsFromFirst(){
    const first = getRow(0);
    if(!first) return;
    const firstBoxes = first.querySelectorAll('input[type="checkbox"][name^="market_"]');
    const selected = Array.from(firstBoxes).filter(cb=>cb.checked).map(cb=>cb.value);
    for(let i=1;i<tbody.children.length;i++){
      const row = getRow(i);
      const boxes = row.querySelectorAll('input[type="checkbox"][name^="market_"]');
      boxes.forEach(cb=>{ cb.checked = selected.includes(cb.value); });
    }
  }

  // 首行更改时，如表头“套用首行”已勾，则自动复制
  tbody.addEventListener('change', (e)=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    const isFirst = tr === getRow(0);
    if(!isFirst) return;
    if(copySlots && copySlots.checked && e.target.name.startsWith('slot_')) applySlotsFromFirst();
    if(copyMarkets && copyMarkets.checked && e.target.name.startsWith('market_')) applyMarketsFromFirst();
  });

  // 点击表头“套用首行”时立即执行一次复制
  copySlots?.addEventListener('change', e=>{ if(e.target.checked) applySlotsFromFirst(); });
  copyMarkets?.addEventListener('change', e=>{ if(e.target.checked) applyMarketsFromFirst(); });

  // 合计
  tbody.addEventListener('input', e=>{
    const tr = e.target.closest('tr');
    if(tr) recalcRow(tr);
  });
  // 初始化合计
  tbody.querySelectorAll('tr').forEach(recalcRow);

  // 动态加行（拷贝最后一行外观，但清空内容并重排 name）
  window.addRows = function(n){
    for(let k=0;k<n;k++){
      const last = tbody.lastElementChild;
      const clone = last.cloneNode(true);
      clone.querySelectorAll('input').forEach(inp=>{
        if(inp.type === 'checkbox') inp.checked = false;
        else inp.value = '';
      });
      const idx = tbody.children.length;
      clone.children[0].textContent = idx+1;
      clone.querySelectorAll('input[type="checkbox"][name^="slot_"]').forEach(cb=>{
        cb.name = `slot_${idx}[]`;
      });
      clone.querySelectorAll('input[type="checkbox"][name^="market_"]').forEach(cb=>{
        cb.name = `market_${idx}[]`;
      });
      clone.querySelector('.sumcell').textContent = '0.00';
      tbody.appendChild(clone);
      // 如果表头“套用首行”已勾，给新行也套用
      if(copySlots?.checked) applySlotsFromFirst();
      if(copyMarkets?.checked) applyMarketsFromFirst();
    }
  }
})();
</script>
</body>
</html>
