<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>2D 下注</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif;padding:20px;}
    h1{margin:0 0 12px}
    .muted{color:#666}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px 8px;font-size:14px;text-align:center}
    th{background:#f6f6f6}
    input[type="text"]{width:70px}
    input[type="number"]{width:90px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
    .btn{padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:6px;cursor:pointer}
    .btn.primary{background:#0969da;color:#fff;border-color:#0969da}
    .chip{display:inline-block;padding:2px 6px;border-radius:6px;color:#fff;font-weight:600}
    .M{background:#ffd400;color:#111} .P{background:#1f6feb} .T{background:#b91c1c}
    .S{background:#5b9bd5} .B{background:#b91c1c} .K{background:#0f5132}
    .W{background:#1f6feb} .H{background:#ffce54;color:#111} .E{background:#f0ad4e;color:#111}
    .flash{padding:10px;border-radius:8px;margin:10px 0}
    .flash.ok{background:#e6ffed;border:1px solid #79d27d}
    .flash.error{background:#ffe6e6;border:1px solid #ff9999}
    .sumcell{min-width:90px;text-align:right;padding-right:10px}
    .slot-locked{opacity:.4}
    .slot-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(54px,1fr));gap:6px}
    .sticky-head th{position:sticky;top:0;background:#f6f6f6;z-index:1}
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h1>下注页面</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat,msg in messages %}
        <div class="flash {{cat}}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="get" class="controls">
    <label>选择日期：</label>
    <input type="date" name="date" value="{{ date }}">
    <button class="btn">切换</button>
    <span class="muted">当前时间：{{ now }}</span>
  </form>

  <form method="post" id="betForm">
    <input type="hidden" name="date" value="{{ date }}">
    <div class="controls">
      <button type="submit" class="btn primary">提交</button>
      <a class="btn" href="/2d/history">查看当日注单</a>
      <a class="btn" href="/2d/winning">查看中奖</a>
    </div>

    <table id="betTable">
      <thead class="sticky-head">
      <tr>
        <th style="width:44px">#</th>
        <th style="width:90px">下注号码</th>
        <th>N1</th>
        <th>N</th>
        <th>BIG</th>
        <th>SMALL</th>
        <th>ODD</th>
        <th>EVEN</th>
        <th style="min-width:340px">
          下注时间段（当日）
          <div class="muted" style="font-weight:normal">可多选；已过锁点的置灰</div>
        </th>
        <th style="min-width:260px">市场</th>
        <th style="width:110px">总额</th>
      </tr>
      </thead>
      <tbody>
      {% for i in range(10) %}
        <tr>
          <td>{{ i+1 }}</td>
          <td><input name="number[]" type="text" maxlength="2" placeholder="07"></td>
          <td><input name="amount_n1[]"   type="number" step="0.01" min="0"></td>
          <td><input name="amount_n[]"    type="number" step="0.01" min="0"></td>
          <td><input name="amount_big[]"  type="number" step="0.01" min="0"></td>
          <td><input name="amount_small[]"type="number" step="0.01" min="0"></td>
          <td><input name="amount_odd[]"  type="number" step="0.01" min="0"></td>
          <td><input name="amount_even[]" type="number" step="0.01" min="0"></td>

          <td>
            <div class="slot-grid">
              {% for s in slots %}
                <label class="{{ 'slot-locked' if s.locked else '' }}">
                  <input type="checkbox" name="slot_{{ i }}[]" value="{{ s.code }}" {% if s.locked %}disabled{% endif %}>
                  {{ s.label }}
                </label>
              {% endfor %}
            </div>
          </td>

          <td>
            <div style="display:grid;grid-template-columns:repeat(9,1fr);gap:6px">
              {% for m in markets %}
                <label title="{{m}}">
                  <input type="checkbox" name="market_{{ i }}[]" value="{{ m }}">
                  <span class="chip {{m}}">{{ m }}</span>
                </label>
              {% endfor %}
            </div>
          </td>

          <td class="sumcell">0.00</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <div class="controls">
      <button type="button" class="btn" onclick="addRows(5)">+ 再加 5 行</button>
      <button type="submit" class="btn primary">提交</button>
    </div>
  </form>

<script>
(function(){
  const table = document.getElementById('betTable');
  const tbody = table.querySelector('tbody');

  function recalcRow(tr){
    const fields = ['amount_n1[]','amount_n[]','amount_big[]','amount_small[]','amount_odd[]','amount_even[]'];
    let sum = 0;
    fields.forEach(name=>{
      const inp = tr.querySelector(`input[name="${name}"]`);
      if(!inp) return;
      const v = parseFloat(inp.value);
      if(!isNaN(v)) sum += v;
    });
    tr.querySelector('.sumcell').textContent = sum.toFixed(2);
  }

  tbody.addEventListener('input', e=>{
    const tr = e.target.closest('tr');
    if(tr) recalcRow(tr);
  });

  // 动态加行（克隆最后一行）
  window.addRows = function(n){
    for(let k=0;k<n;k++){
      const last = tbody.lastElementChild;
      const clone = last.cloneNode(true);
      // 清空输入与勾选
      clone.querySelectorAll('input').forEach(inp=>{
        if(inp.type === 'checkbox') inp.checked = false;
        else inp.value = '';
      });
      // 更新序号与 name 中的行索引
      const idx = tbody.children.length;
      clone.children[0].textContent = idx+1;
      clone.querySelectorAll('input[type="checkbox"][name^="slot_"]').forEach(cb=>{
        cb.name = `slot_${idx}[]`;
      });
      clone.querySelectorAll('input[type="checkbox"][name^="market_"]').forEach(cb=>{
        cb.name = `market_${idx}[]`;
      });
      clone.querySelector('.sumcell').textContent = '0.00';
      tbody.appendChild(clone);
    }
  }

  // 初始化所有行的总额
  tbody.querySelectorAll('tr').forEach(recalcRow);
})();
</script>
</body>
</html>
