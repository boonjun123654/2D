<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>2D 下注系统</title>
  <style>
    :root{
      --c-border:#d0d7de; --c-head:#f6f8fa; --c-muted:#666;
      --M:#ffff00; --P:#0000ff; --T:#cc0000; --S:#4c8ed1;
      --B:#e51d20; --K:#008835; --W:#00540e; --H:#fed606; --E:#ffa500; --sel:#2d6bff;
      --nav-bg:#0b1220; --nav-fg:#fff; --nav-muted:#b6c2cf; --brand:#1b84ff;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif; padding:12px}
    h1,h2{margin:0}

    .header-row{
      display:flex; align-items:center; gap:14px; margin:0 0 10px;
    }
    .admin-agent{
      margin-left:auto; display:flex; align-items:center; gap:8px;
      font-size:14px;
    }
    .admin-agent select{
      height:34px; padding:4px 8px; border:1px solid #d0d7de; border-radius:8px;
      background:#fff;
    }

    /* 顶栏：按钮 + 标题 并排 */
    .topbar{
      position:sticky; top:0; z-index:1000;
      display:flex; align-items:center; gap:10px;
      background:#f6f8fa; border:1px solid #e5e7eb; border-radius:12px;
      padding:8px 10px; margin-bottom:12px;
      box-shadow:0 10px 28px rgba(16,24,40,.06);
    }

    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--c-border);border-radius:10px;overflow:hidden}
    th,td{border:1px solid var(--c-border);padding:6px 8px;text-align:center}
    thead th{background:var(--c-head)}
    tfoot td{background:#fafbfc}
    input[type="text"]{text-align:center}
    input.money{width:64px;text-align:right}

    .headbox{position:relative;display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center;border-radius:6px}
    .headbox input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .headbox span{width:16px;height:16px;background:#fff;border:1px solid var(--c-border);border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;pointer-events:none}
    .headbox input:checked + span{box-shadow:0 0 0 2px #111 inset;background:#e8f0ff}
    .headbox input:checked + span::after{content:"✓";display:block;text-align:center;font-weight:700;font-size:12px;line-height:16px;color:#111}

    .Mbg{background:var(--M)} .Pbg{background:var(--P)} .Tbg{background:var(--T)}
    .Sbg{background:var(--S)} .Bbg{background:var(--B)} .Kbg{background:var(--K)}
    .Wbg{background:var(--W)} .Hbg{background:var(--H)} .Ebg{background:var(--E)}

    .mtick{position:relative;display:block;width:100%;height:34px;align-items:center;justify-content:center;border-radius:4px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.28) inset;margin:auto}
    .mtick.M{background:var(--M)} .mtick.P{background:var(--P)} .mtick.T{background:var(--T)}
    .mtick.S{background:var(--S)} .mtick.B{background:var(--B)} .mtick.K{background:var(--K)}
    .mtick.W{background:var(--W)} .mtick.H{background:var(--H)} .mtick.E{background:var(--E)}

    .num-col{width:86px}
    .amt-col{width:72px}
    .slot-head,.slot-cell{width:46px}
    .market-head,.market-cell{width:46px}
    .ck{width:18px;height:18px}

    /* 汉堡按钮（非 fixed，放到顶栏里） */
    .hamburger{
      width:42px; height:42px; border-radius:10px; border:1px solid #d0d7de;
      background:#fff; display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .hamburger span, .hamburger span::before, .hamburger span::after{
      content:""; display:block; width:20px; height:2px; background:#111; border-radius:2px;
      position:relative; transition:transform .2s ease, opacity .2s ease;
    }
    .hamburger span::before{ position:absolute; top:-6px; left:0 }
    .hamburger span::after{ position:absolute; top:6px; left:0 }
    .hamburger.active span{ transform:rotate(45deg) }
    .hamburger.active span::before{ transform:rotate(90deg); top:0 }
    .hamburger.active span::after{ opacity:0 }

    .drawer{
      position:fixed; inset:0 auto 0 0; width:280px; max-width:85vw;
      background:var(--nav-bg); color:var(--nav-fg);
      transform:translateX(-100%); transition:transform .22s ease-out;
      z-index:1090; box-shadow:2px 0 16px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform:translateX(0) }
    .drawer-header{padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:10px;}
    .brand-dot{width:10px; height:10px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 3px rgba(27,132,255,.25)}
    .drawer-title{font-weight:700}
    .drawer-user{font-size:12px; color:var(--nav-muted)}
    .drawer-nav{padding:8px}
    .nav-link{display:flex; align-items:center; gap:10px; color:#e6eef8; text-decoration:none; padding:10px 12px; border-radius:8px;}
    .nav-link:hover{ background:rgba(255,255,255,.06) }
    .nav-link .dot{width:8px; height:8px; border-radius:50%; background:#9bb8ff}
    .drawer-section{padding:8px 12px; font-size:12px; color:var(--nav-muted)}
    .drawer-footer{margin-top:auto; padding:10px; border-top:1px solid rgba(255,255,255,.08)}
    .logout{color:#ffd1d1}
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); backdrop-filter:saturate(120%) blur(1px); opacity:0; visibility:hidden; transition:.2s ease; z-index:1080;}
    .backdrop.show{ opacity:1; visibility:visible }

    @media (max-width: 768px){
      .amt-col{width:62px}
      .slot-head,.slot-cell,.market-head,.market-cell{width:42px}
      input.money{width:56px}
    }
  </style>
</head>
<body>
  <!-- 顶栏（按钮 + 标题） -->
  <div class="topbar">
    <button id="hamburgerBtn" class="hamburger" aria-label="打开主菜单" aria-controls="appDrawer" aria-expanded="false">
      <span></span>
    </button>
    <h2>下注页面</h2>
    {% if session.get('role') == 'admin' %}
    <div class="admin-agent">
      <label for="agentSelect">下注代理：</label>
      <select id="agentSelect" name="agent_id">
        {% for a in (agents or []) %}
          <option value="{{ a.id }}" {% if a.id == (selected_agent_id or 1) %}selected{% endif %}>
            [#{{ a.id }}] {{ a.username }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>

  <!-- 抽屉菜单 -->
  <div id="drawerBackdrop" class="backdrop" tabindex="-1" aria-hidden="true"></div>
  <aside id="appDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="brand-dot"></div>
      <div>
        <div class="drawer-title">管理菜单</div>
        <div class="drawer-user">
          {{ session.get('username') or '未登录' }}{% if session.get('role') %} · {{ session.get('role') }}{% endif %}
        </div>
      </div>
    </div>
    <nav class="drawer-nav">
      <div class="drawer-section">常用</div>
      <a class="nav-link" href="/home"><span class="dot"></span>主页（赔率）</a>
      <a class="nav-link" href="/2d/bet"><span class="dot"></span>2D 下注</a>
      <a class="nav-link" href="/2d/history"><span class="dot"></span>当日注单</a>
      <a class="nav-link" href="/2d/winning"><span class="dot"></span>查看中奖</a>
      {% if session.get('role') == 'admin' %}
      <div class="drawer-section">管理员</div>
      <a class="nav-link" href="/agents"><span class="dot"></span>代理管理</a>
      {% endif %}
    </nav>
    <div class="drawer-footer">
      {% if session.get('role') %}
        <a class="nav-link logout" href="/logout"><span class="dot" style="background:#ff7b7b"></span>退出登录</a>
      {% else %}
        <a class="nav-link" href="/login"><span class="dot" style="background:#7bff9a"></span>登录</a>
      {% endif %}
    </div>
  </aside>

  <form method="post" id="betForm" onsubmit="return handleBet();">
    <input type="hidden" name="date" value="{{ date }}">

    <table>
      <thead>
      <tr>
        <th rowspan="2">#</th>
        <th rowspan="2" class="num-col">下注号码</th>
        <th rowspan="2" class="amt-col">
          N1<br>
          <label class="headbox"><input type="checkbox" id="fillN1" onclick="copyAmountDown('N1', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          N<br>
          <label class="headbox"><input type="checkbox" id="fillN" onclick="copyAmountDown('N', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          BIG<br>
          <label class="headbox"><input type="checkbox" id="fillBIG" onclick="copyAmountDown('BIG', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          SMALL<br>
          <label class="headbox"><input type="checkbox" id="fillSMALL" onclick="copyAmountDown('SMALL', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          ODD<br>
          <label class="headbox"><input type="checkbox" id="fillODD" onclick="copyAmountDown('ODD', this.checked)"><span></span></label>
        </th>
        <th rowspan="2" class="amt-col">
          EVEN<br>
          <label class="headbox"><input type="checkbox" id="fillEVEN" onclick="copyAmountDown('EVEN', this.checked)"><span></span></label>
        </th>

        <th colspan="15">下注时间段（当日 09–23）</th>
        <th colspan="9">市场</th>
        <th rowspan="2">总额</th>
      </tr>
      <tr>
        {% set slots = [9,10,11,12,13,14,15,16,17,18,19,20,21,22,23] %}
        {% for h in slots %}
          <th class="slot-head">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox"><input type="checkbox" id="select_slot_{{ loop.index0 }}" onclick="toggleColumn('slot', {{ loop.index0 }})"><span></span></label>
              <small class="muted">{{ "%02d"|format(h) }}</small>
            </div>
          </th>
        {% endfor %}
        {% set market_order = ['M','P','T','S','B','K','W','H','E'] %}
        {% for m in market_order %}
          <th class="market-head {{ m }}bg">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <label class="headbox"><input type="checkbox" id="select_market_{{ m }}" onclick="toggleColumn('market', '{{ m }}')"><span></span></label>
              <strong style="color:#111">{{ m }}</strong>
            </div>
          </th>
        {% endfor %}
      </tr>
      </thead>

      <tbody>
      {% for i in range(1, 13) %}
        <tr>
          <td>{{ i }}</td>
          <td class="num-col">
            <input type="text" name="number{{ i }}" maxlength="2" inputmode="numeric" pattern="[0-9]{2}"
                   oninput="this.value=this.value.replace(/[^0-9]/g,'')" style="width:80px">
          </td>

          <td class="amt-col"><input class="money" type="text" name="N1{{ i }}"   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="N{{ i }}"    inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="BIG{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="SMALL{{ i }}"inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="ODD{{ i }}"  inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>
          <td class="amt-col"><input class="money" type="text" name="EVEN{{ i }}" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>

          {% for h in slots %}
            <td class="slot-cell">
              <input class="ck slot_col_{{ loop.index0 }}" type="checkbox" name="slot{{ i }}_{{ loop.index0 }}">
            </td>
          {% endfor %}

          {% for m in market_order %}
            <td class="market-cell {{ m }}bg">
              <input class="ck market_col_{{ m }}" type="checkbox" name="market{{ i }}_{{ m }}">
            </td>
          {% endfor %}

          <td><span class="row-total">0.00</span></td>
        </tr>
      {% endfor %}
      </tbody>

      <tfoot>
      <tr>
        <td colspan="33" style="text-align:right;font-weight:bold">总下注金额：RM <span id="grand-total">0.00</span></td>
      </tr>
      </tfoot>
    </table>

    <div style="margin-top:10px">
      <button type="submit" style="font-size:16px;padding:8px 16px">提交</button>
      <button type="reset"  style="font-size:16px;padding:8px 16px">清除</button>
    </div>
  </form>

<script>
/******************* 主菜单：展开/收起 ********************/
(function(){
  const btn = document.getElementById('hamburgerBtn');
  const drawer = document.getElementById('appDrawer');
  const backdrop = document.getElementById('drawerBackdrop');

  function openDrawer(){
    drawer.classList.add('open');
    backdrop.classList.add('show');
    btn.classList.add('active');
    btn.setAttribute('aria-expanded','true');
    drawer.setAttribute('aria-hidden','false');
    backdrop.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
    drawer.classList.remove('open');
    backdrop.classList.remove('show');
    btn.classList.remove('active');
    btn.setAttribute('aria-expanded','false');
    drawer.setAttribute('aria-hidden','true');
    backdrop.setAttribute('aria-hidden','true');
  }
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    drawer.classList.contains('open') ? closeDrawer() : openDrawer();
  });
  backdrop.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeDrawer(); });
})();

/**************** 金额“复制向下” ****************/
function copyAmountDown(col, checked){
  const first = document.querySelector(`input[name="${col}1"]`);
  const v = first ? first.value : '';
  for(let i=2;i<=12;i++){
    const el = document.querySelector(`input[name="${col}${i}"]`);
    if(!el) continue;
    el.value = checked ? v : '';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  updateTotals();
}

/**************** 列总控：时间段/市场 ****************/
function toggleColumn(type, key){
  if(type==='slot'){
    const state = document.getElementById(`select_slot_${key}`).checked;
    document.querySelectorAll(`.slot_col_${key}`).forEach(cb=>cb.checked = state);
  }
  if(type==='market'){
    const state = document.getElementById(`select_market_${key}`).checked;
    document.querySelectorAll(`.market_col_${key}`).forEach(cb=>cb.checked = state);
  }
  updateTotals();
}

/**************** 计算总额 ****************/
function updateTotals(){
  let grand = 0;
  const rows = Array.from(document.querySelectorAll('#betForm tbody tr'));
  rows.forEach((tr, idx) => {
    const i = idx + 1;
    const getVal = (name) => parseFloat(tr.querySelector(`input[name="${name}${i}"]`)?.value) || 0;
    const base = getVal('N1') + getVal('N') + getVal('BIG') + getVal('SMALL') + getVal('ODD') + getVal('EVEN');
    const slotCount   = tr.querySelectorAll('.slot-cell   input[type="checkbox"]:checked').length;
    const marketCount = tr.querySelectorAll('.market-cell input[type="checkbox"]:checked').length;
    const rowTotal = base * slotCount * marketCount;
    const cell = tr.querySelector('.row-total'); if (cell) cell.textContent = rowTotal.toFixed(2);
    grand += rowTotal;
  });
  const g = document.getElementById('grand-total'); if (g) g.textContent = grand.toFixed(2);
}

/**************** 提交前确认 ****************/
function handleBet(){
  updateTotals();
  const grand = parseFloat(document.getElementById('grand-total').textContent)||0;
  const popup = buildBetPopupText();
  if (popup) localStorage.setItem('bet_popup', popup);
  return confirm(`下注总金额 = RM ${grand.toFixed(2)}\n确认下注？`);
}

/**************** 初始化监听 ****************/
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('input[type="text"]').forEach(el=>el.addEventListener('input', updateTotals));
  document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change', updateTotals));
  updateTotals();
});

/**************** 成功弹窗 ****************/
const params = new URLSearchParams(location.search);
if (params.get('success') === '1') {
  const saved = localStorage.getItem('bet_popup');
  if (saved) showBetPopup(saved);
  localStorage.removeItem('bet_popup');
  const url = new URL(location.href);
  url.searchParams.delete('success');
  history.replaceState({}, document.title, url.pathname + (url.searchParams.toString() ? `?${url.searchParams}` : ''));
}

function fmtNum(n){
  const v = Number(n);
  if (!isFinite(v)) return "0";
  return v.toFixed(2).replace(/\.?0+$/, "");
}

function buildBetPopupText(){
  const rows = Array.from(document.querySelectorAll('#betForm tbody tr'));
  const H_BASE = 9; // 09~23
  const MARKET_ORDER = ['M','P','T','S','B','K','W','H','E'];

  const slotSet   = new Set();     // 合并所有行勾选的时间段
  const marketSet = new Set();     // 合并所有行勾选的市场
  const lines     = [];            // 每个号码的明细行

  rows.forEach((tr, idx) => {
    const i = idx + 1;
    const number = tr.querySelector(`input[name="number${i}"]`)?.value?.trim() || "";
    if (!number) return;

    // 取各金额（>0 才展示），并做去尾零显示
    const parts = [];
    const pushIf = (key, label) => {
      const el = tr.querySelector(`input[name="${key}${i}"]`);
      if (!el) return;
      const v = parseFloat((el.value || "").trim());
      if (isFinite(v) && v > 0) parts.push(`${fmtNum(v)}${label}`);
    };
    pushIf("N1","N1"); pushIf("N","N"); pushIf("BIG","B");
    pushIf("SMALL","S"); pushIf("ODD","O"); pushIf("EVEN","E");
    if (!parts.length) return;

    // 当前行选中的时间段、市场（用于合并）
    tr.querySelectorAll('.slot-cell input[type="checkbox"]:checked').forEach(cb=>{
      const idx = parseInt(cb.name.split('_').pop(),10);
      if (!Number.isNaN(idx)) slotSet.add(H_BASE + idx);
    });
    MARKET_ORDER.forEach(m=>{
      if (tr.querySelector(`input[name="market${i}_${m}"]`)?.checked) marketSet.add(m);
    });

    // 本号码明细行（不再附加“时段/市场”）
    lines.push(`${number} = ${parts.join(' ')}`);
  });

  // 第一行：时间段 例如 21-22-23（无则为“-”）
  const slotLine = Array.from(slotSet).sort((a,b)=>a-b)
    .map(h => String(h).padStart(2,'0')).join('-') || '-';

  // 第二行：*市场 例如 *MP（按固定顺序，去重合并；无则为 *-）
  const marketLine = '*' + (MARKET_ORDER.filter(m => marketSet.has(m)).join('') || '-');

  // 合计：从页面合计读取并格式化
  const grandRaw = parseFloat(document.getElementById('grand-total')?.textContent || '0');
  const gt = fmtNum(grandRaw);

  // 组装最终文本
  const out = [slotLine, marketLine];
  if (lines.length) out.push(...lines);
  out.push('', `GT=${gt}`);
  return out.join('\n');
}

function showBetPopup(text) {
  if (!text) return;
  const old = document.getElementById("resultModal"); if (old) old.remove();
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div id="resultModal" style="position:fixed; top:20px; left:10px; right:10px; background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.15); padding:16px; z-index:9999; max-width:420px; margin:auto; font-family:system-ui, sans-serif;">
      <div id="resultText" style="white-space:pre-wrap; word-break:break-word; margin-bottom:16px; font-size:14px;">${text}</div>
      <div style="display:flex; gap:10px;">
        <button onclick="copyResult()" style="flex:1; padding:8px; background:#007bff; color:#fff; border:0; border-radius:8px;">复制</button>
        <button onclick="confirmResult()" style="flex:1; padding:8px; background:#28a745; color:#fff; border:0; border-radius:8px;">确认</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  window.scrollTo({top:0, behavior:'smooth'});
}
function copyResult(){
  const text = document.getElementById('resultText')?.innerText || '';
  if (!text) return;
  navigator.clipboard.writeText(text).then(()=>alert('✅ 已复制下注信息')).catch(()=>alert('❌ 复制失败，请手动选择文字'));
}
function confirmResult(){ document.getElementById('resultModal')?.remove(); }
</script>
</body>
</html>
